{% extends "pm/base.html" %}
{% load static %}

{% block content %}
<div class="breadcrumb">
    <a href="{% url 'project_list' %}">projects</a> &gt; my work
</div>

<div class="page-title">My Work</div>

<details class="section filters-section">
    <summary class="section-title">Filters</summary>
    <form method="get" class="filters-form">
        <div class="filters-row">
            <div class="filter-item">
                <label for="status">Status</label>
                <select name="status" id="status">
                    <option value="">All</option>
                    <option value="todo" {% if filters.status == 'todo' %}selected{% endif %}>Todo</option>
                    <option value="in_progress" {% if filters.status == 'in_progress' %}selected{% endif %}>In Progress</option>
                    <option value="done" {% if filters.status == 'done' %}selected{% endif %}>Done</option>
                    <option value="on_hold" {% if filters.status == 'on_hold' %}selected{% endif %}>On Hold</option>
                    <option value="blocked" {% if filters.status == 'blocked' %}selected{% endif %}>Blocked</option>
                    <option value="cancelled" {% if filters.status == 'cancelled' %}selected{% endif %}>Cancelled</option>
                    <option value="next" {% if filters.status == 'next' %}selected{% endif %}>Next</option>
                </select>
            </div>
            <div class="filter-item">
                <label for="priority">Priority</label>
                <select name="priority" id="priority">
                    <option value="">All</option>
                    <option value="1" {% if filters.priority == '1' %}selected{% endif %}>P1</option>
                    <option value="2" {% if filters.priority == '2' %}selected{% endif %}>P2</option>
                    <option value="3" {% if filters.priority == '3' %}selected{% endif %}>P3</option>
                    <option value="4" {% if filters.priority == '4' %}selected{% endif %}>P4</option>
                    <option value="5" {% if filters.priority == '5' %}selected{% endif %}>P5</option>
                </select>
            </div>
            <div class="filter-item">
                <label for="project">Project</label>
                <select name="project" id="project">
                    <option value="">All</option>
                    {% for project in projects %}
                    <option value="{{ project.id }}" {% if filters.project == project.id %}selected{% endif %}>{{ project.title }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="filter-item">
                <label for="epic">Epic</label>
                <select name="epic" id="epic">
                    <option value="">All</option>
                    {% for project in projects %}
                        {% for epic in project.epics %}
                        <option value="{{ epic.id }}" {% if filters.epic == epic.id %}selected{% endif %}>{{ epic.title }}</option>
                        {% endfor %}
                    {% endfor %}
                </select>
            </div>
            <div class="filter-item">
                <label for="due">Due</label>
                <select name="due" id="due">
                    <option value="">All</option>
                    <option value="today" {% if filters.due == 'today' %}selected{% endif %}>Today</option>
                    <option value="due_soon" {% if filters.due == 'due_soon' %}selected{% endif %}>Due soon</option>
                    <option value="overdue" {% if filters.due == 'overdue' %}selected{% endif %}>Overdue</option>
                    <option value="none" {% if filters.due == 'none' %}selected{% endif %}>No due date</option>
                </select>
            </div>
            <div class="filter-actions">
                <button type="submit">Apply</button>
                <a href="{% url 'my_work' %}" class="button button-secondary">Reset</a>
            </div>
        </div>
    </form>
</details>

{% comment %}
Helper template to render work item tables
Include directly in sections below
{% endcomment %}

<div class="section">
    <div class="section-title">Open</div>
    {% if open_items %}
        <table class="work-table" id="work-table-open">
            <thead>
                <tr>
                    <th>Task Name</th>
                    <th>Status</th>
                    <th>Priority</th>
                    <th>Project</th>
                    <th>Epic</th>
                    <th>Due Date</th>
                </tr>
            </thead>
            <tbody>
                {% for item in open_items %}
                    {% if item.type == 'task' %}
                        {% if item.epic_id %}
                            {% url 'task_detail' project=item.project_id epic=item.epic_id task=item.id as task_url %}
                        {% else %}
                            {% url 'task_detail_no_epic' project=item.project_id task=item.id as task_url %}
                        {% endif %}
                    {% else %}
                        {% if item.epic_id %}
                            {% url 'subtask_detail' project=item.project_id epic=item.epic_id task=item.task_id subtask=item.id as task_url %}
                        {% else %}
                            {% url 'subtask_detail_no_epic' project=item.project_id task=item.task_id subtask=item.id as task_url %}
                        {% endif %}
                    {% endif %}
                    <tr data-task-url="{{ task_url }}">
                        <td class="task-name"><a href="{{ task_url }}">{{ item.title }}</a></td>
                        <td><span class="status-badge status-{{ item.status }}">{{ item.status_display|default:item.status }}</span></td>
                        <td>
                            {% if item.priority %}
                                <span class="priority-badge priority-{{ item.priority }}">P{{ item.priority }}</span>
                            {% else %}
                                <span class="priority-badge priority-empty">—</span>
                            {% endif %}
                        </td>
                        <td class="project-col">{{ item.project_title|default:item.project_id }}</td>
                        <td class="epic-col">{{ item.epic_title|default:'—' }}</td>
                        <td class="due-date">{{ item.due_date|default:'—' }}</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <div class="work-table-empty">No open items.</div>
    {% endif %}
</div>

<div class="section">
    <div class="section-title">In Progress</div>
    {% if in_progress %}
        <table class="work-table" id="work-table-in-progress">
            <thead>
                <tr>
                    <th>Task Name</th>
                    <th>Status</th>
                    <th>Priority</th>
                    <th>Project</th>
                    <th>Epic</th>
                    <th>Due Date</th>
                </tr>
            </thead>
            <tbody>
                {% for item in in_progress %}
                    {% if item.type == 'task' %}
                        {% if item.epic_id %}
                            {% url 'task_detail' project=item.project_id epic=item.epic_id task=item.id as task_url %}
                        {% else %}
                            {% url 'task_detail_no_epic' project=item.project_id task=item.id as task_url %}
                        {% endif %}
                    {% else %}
                        {% if item.epic_id %}
                            {% url 'subtask_detail' project=item.project_id epic=item.epic_id task=item.task_id subtask=item.id as task_url %}
                        {% else %}
                            {% url 'subtask_detail_no_epic' project=item.project_id task=item.task_id subtask=item.id as task_url %}
                        {% endif %}
                    {% endif %}
                    <tr data-task-url="{{ task_url }}">
                        <td class="task-name"><a href="{{ task_url }}">{{ item.title }}</a></td>
                        <td><span class="status-badge status-{{ item.status }}">{{ item.status_display|default:item.status }}</span></td>
                        <td>
                            {% if item.priority %}
                                <span class="priority-badge priority-{{ item.priority }}">P{{ item.priority }}</span>
                            {% else %}
                                <span class="priority-badge priority-empty">—</span>
                            {% endif %}
                        </td>
                        <td class="project-col">{{ item.project_title|default:item.project_id }}</td>
                        <td class="epic-col">{{ item.epic_title|default:'—' }}</td>
                        <td class="due-date">{{ item.due_date|default:'—' }}</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <div class="work-table-empty">No items in progress.</div>
    {% endif %}
</div>

<div class="section">
    <div class="section-title">Due Soon (7 days)</div>
    {% if due_soon %}
        <table class="work-table" id="work-table-due-soon">
            <thead>
                <tr>
                    <th>Task Name</th>
                    <th>Status</th>
                    <th>Priority</th>
                    <th>Project</th>
                    <th>Epic</th>
                    <th>Due Date</th>
                </tr>
            </thead>
            <tbody>
                {% for item in due_soon %}
                    {% if item.type == 'task' %}
                        {% if item.epic_id %}
                            {% url 'task_detail' project=item.project_id epic=item.epic_id task=item.id as task_url %}
                        {% else %}
                            {% url 'task_detail_no_epic' project=item.project_id task=item.id as task_url %}
                        {% endif %}
                    {% else %}
                        {% if item.epic_id %}
                            {% url 'subtask_detail' project=item.project_id epic=item.epic_id task=item.task_id subtask=item.id as task_url %}
                        {% else %}
                            {% url 'subtask_detail_no_epic' project=item.project_id task=item.task_id subtask=item.id as task_url %}
                        {% endif %}
                    {% endif %}
                    <tr data-task-url="{{ task_url }}">
                        <td class="task-name"><a href="{{ task_url }}">{{ item.title }}</a></td>
                        <td><span class="status-badge status-{{ item.status }}">{{ item.status_display|default:item.status }}</span></td>
                        <td>
                            {% if item.priority %}
                                <span class="priority-badge priority-{{ item.priority }}">P{{ item.priority }}</span>
                            {% else %}
                                <span class="priority-badge priority-empty">—</span>
                            {% endif %}
                        </td>
                        <td class="project-col">{{ item.project_title|default:item.project_id }}</td>
                        <td class="epic-col">{{ item.epic_title|default:'—' }}</td>
                        <td class="due-date">{{ item.due_date|default:'—' }}</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <div class="work-table-empty">No items due soon.</div>
    {% endif %}
</div>

<div class="section">
    <div class="section-title">Overdue</div>
    {% if overdue %}
        <table class="work-table" id="work-table-overdue">
            <thead>
                <tr>
                    <th>Task Name</th>
                    <th>Status</th>
                    <th>Priority</th>
                    <th>Project</th>
                    <th>Epic</th>
                    <th>Due Date</th>
                </tr>
            </thead>
            <tbody>
                {% for item in overdue %}
                    {% if item.type == 'task' %}
                        {% if item.epic_id %}
                            {% url 'task_detail' project=item.project_id epic=item.epic_id task=item.id as task_url %}
                        {% else %}
                            {% url 'task_detail_no_epic' project=item.project_id task=item.id as task_url %}
                        {% endif %}
                    {% else %}
                        {% if item.epic_id %}
                            {% url 'subtask_detail' project=item.project_id epic=item.epic_id task=item.task_id subtask=item.id as task_url %}
                        {% else %}
                            {% url 'subtask_detail_no_epic' project=item.project_id task=item.task_id subtask=item.id as task_url %}
                        {% endif %}
                    {% endif %}
                    <tr data-task-url="{{ task_url }}">
                        <td class="task-name"><a href="{{ task_url }}">{{ item.title }}</a></td>
                        <td><span class="status-badge status-{{ item.status }}">{{ item.status_display|default:item.status }}</span></td>
                        <td>
                            {% if item.priority %}
                                <span class="priority-badge priority-{{ item.priority }}">P{{ item.priority }}</span>
                            {% else %}
                                <span class="priority-badge priority-empty">—</span>
                            {% endif %}
                        </td>
                        <td class="project-col">{{ item.project_title|default:item.project_id }}</td>
                        <td class="epic-col">{{ item.epic_title|default:'—' }}</td>
                        <td class="due-date">{{ item.due_date|default:'—' }}</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <div class="work-table-empty">No overdue items.</div>
    {% endif %}
</div>

<script src="{% static 'pm/js/table-sort.js' %}"></script>
{% endblock %}
