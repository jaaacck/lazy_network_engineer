{% extends "pm/base.html" %}
{% load markdown_extras %}

{% block content %}
<div class="breadcrumb">
    <a href="{% url 'project_list' %}">projects</a> &gt; {{ metadata.title }}
</div>

<div class="page-title">
    <span>{{ metadata.title }}</span>
    <div style="display: flex; align-items: center; gap: 10px;">
        <div class="badge-group">
            <span class="badge badge-status status-{{ metadata.status }}">{{ metadata.status }}</span>
        </div>
        <div class="mode-toggle">
            <a href="{% url 'project_detail' project=project %}" {% if not edit_mode %}class="active"{% endif %}>view</a>
            <a href="{% url 'project_detail' project=project %}?edit=true" {% if edit_mode %}class="active"{% endif %}>edit</a>
            <a href="{% url 'kanban_project' project=project %}">kanban</a>
            {% if not metadata.archived %}
            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="archive" value="1">
                <button type="submit">Archive</button>
            </form>
            {% else %}
            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="unarchive" value="1">
                <button type="submit">Unarchive</button>
            </form>
            {% endif %}
        </div>
    </div>
</div>

{% if markdown_total > 0 or checklist_total > 0 %}
<div class="section">
    {% if checklist_total > 0 %}
    <div class="section-title">Checklist Progress ({{ checklist_progress }}%)</div>
    <div class="progress">
        <div class="progress-bar" style="width: {{ checklist_progress }}%"></div>
    </div>
    {% endif %}
    
    {% if markdown_total > 0 %}
    <div class="section-title">Description Progress ({{ markdown_progress }}%)</div>
    <div class="progress">
        <div class="progress-bar" style="width: {{ markdown_progress }}%"></div>
    </div>
    {% endif %}
    </div>
{% endif %}

{% if not edit_mode %}
    <!-- View Mode -->
    {% if content %}
    <div class="section">
        <div class="content">
            {{ content|markdownify|safe }}
        </div>
    </div>
    {% endif %}

    <!-- All Epics -->
    <div class="section">
        <div class="section-title">Epics</div>
        <table id="epics-table"{% if not epics %} style="display: none;"{% endif %}>
            <thead>
            <tr>
                <th>Epic</th>
                <th>Status</th>
                <th>Progress</th>
            </tr>
            </thead>
            <tbody id="epics-tbody">
            {% for epic in epics %}
            <tr>
                <td>{% if epic.seq_id %}<span class="seq-id">{{ epic.seq_id }}</span>{% endif %}<a href="{% url 'epic_detail' project=project epic=epic.id %}">{{ epic.title }}</a></td>
                <td><span class="badge badge-status status-{{ epic.status }}">{{ epic.status }}</span></td>
                <td>
                    {{ epic.completed_tasks }}/{{ epic.total_tasks }}
                    {% if epic.total_tasks > 0 %}
                    <div class="progress">
                        <div class="progress-bar" style="width: {{ epic.progress_percentage }}%"></div>
                    </div>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
        <div id="epics-empty" class="empty"{% if epics %} style="display: none;"{% endif %}>No epics yet.</div>
        <form method="post" action="{% url 'new_epic' project=project %}" class="quick-setting-form ajax-create-form" id="new-epic-form">
            {% csrf_token %}
            <input type="text" name="title" id="quick_epic_title" placeholder="New epic title..." required>
            <select name="priority">
                <option value="">Priority</option>
                <option value="1">P1</option>
                <option value="2">P2</option>
                <option value="3">P3</option>
                <option value="4">P4</option>
                <option value="5">P5</option>
            </select>
            <select name="status">
                <option value="active">active</option>
                <option value="completed">completed</option>
                <option value="canceled">canceled</option>
            </select>
            <button type="submit">Create</button>
        </form>
    </div>

    <!-- Archived Epics -->
    {% if archived_epics %}
    <details class="section">
        <summary class="section-title">Archived Epics ({{ archived_epics|length }})</summary>
        <table>
            <thead>
            <tr>
                <th>Epic</th>
                <th>Status</th>
                <th>Progress</th>
            </tr>
            </thead>
            <tbody>
            {% for epic in archived_epics %}
            <tr>
                <td>{% if epic.seq_id %}<span class="seq-id">{{ epic.seq_id }}</span>{% endif %}<a href="{% url 'epic_detail' project=project epic=epic.id %}">{{ epic.title }}</a></td>
                <td><span class="badge badge-status status-{{ epic.status }}">{{ epic.status }}</span></td>
                <td>
                    {{ epic.completed_tasks }}/{{ epic.total_tasks }}
                    {% if epic.total_tasks > 0 %}
                    <div class="progress">
                        <div class="progress-bar" style="width: {{ epic.progress_percentage }}%"></div>
                    </div>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </details>
    {% endif %}

    <div class="section">
        <div class="section-title">Recent Activity</div>
        <div class="activity-filters">
            <label>
                <input type="checkbox" id="filter-system" checked> System messages
            </label>
            <label>
                <input type="checkbox" id="filter-user" checked> User messages
            </label>
        </div>
        {% if activity %}
        <div id="activity-list">
        {% for item in activity %}
        <div class="update update-{{ item.update_type|default:'user' }}" data-update-type="{{ item.update_type|default:'user' }}">
            <div class="update-meta">
                <span class="update-timestamp">{{ item.timestamp|date:"Y-m-d H:i" }}</span>
                {% if item.update_type == 'system' %}
                <span class="update-type-badge">system</span>
                {% else %}
                <span class="update-type-badge">user</span>
                {% endif %}
                <span class="update-meta-item">{{ item.entity_type|default:item.type }}</span>
            </div>
            <div class="update-content content">
                <a href="{{ item.url }}">{{ item.title }}</a>
                <div>{{ item.content|markdownify|safe }}</div>
            </div>
        </div>
        {% endfor %}
        </div>
        {% else %}
        <div class="empty">No recent activity.</div>
        {% endif %}
    </div>

{% else %}
    <!-- Edit Mode -->
    <div class="section">
        <form method="post">
            {% csrf_token %}

            <div class="form-group">
                <label for="title">Title</label>
                <input type="text" name="title" id="title" value="{{ metadata.title }}" required>
            </div>

            <div class="form-group">
                <label for="status">Status</label>
                <select name="status" id="status">
                    <option value="active" {% if metadata.status == 'active' %}selected{% endif %}>active</option>
                    <option value="completed" {% if metadata.status == 'completed' %}selected{% endif %}>completed</option>
                    <option value="canceled" {% if metadata.status == 'canceled' %}selected{% endif %}>canceled</option>
                </select>
            </div>

            <div class="form-group">
                <label for="color">Project Color</label>
                <input type="color" name="color" id="color" value="{{ metadata.color|default:'#ff6600' }}" class="color-input">
                <div style="font-size: 8pt; color: #828282; margin-top: 4px;">Used to identify this project on the calendar</div>
            </div>

            <div class="form-group">
                <label for="content">Description (markdown)</label>
                <textarea name="content" id="content">{{ content }}</textarea>
            </div>

            <div class="form-actions">
                <button type="submit">Save Changes</button>
                <a href="{% url 'project_detail' project=project %}" class="button button-secondary">Cancel</a>
            </div>
        </form>
    </div>
{% endif %}

<script>
// AJAX epic creation
var epicForm = document.getElementById('new-epic-form');
if (epicForm) {
    epicForm.addEventListener('submit', function(e) {
        e.preventDefault();
        var formData = new FormData(epicForm);
        
        fetch(epicForm.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(function(response) { return response.json(); })
        .then(function(data) {
            if (data.success) {
                // Show table if hidden
                var table = document.getElementById('epics-table');
                var tbody = document.getElementById('epics-tbody');
                var empty = document.getElementById('epics-empty');
                
                table.style.display = '';
                empty.style.display = 'none';
                
                // Create new row
                var tr = document.createElement('tr');
                var seqIdHtml = data.seq_id ? '<span class="seq-id">' + data.seq_id + '</span>' : '';
                tr.innerHTML = '<td>' + seqIdHtml + '<a href="' + data.url + '">' + escapeHtml(data.title) + '</a></td>' +
                    '<td><span class="badge badge-status status-' + data.status + '">' + data.status + '</span></td>' +
                    '<td>0/0</td>';
                tbody.appendChild(tr);
                
                // Reset form
                epicForm.reset();
                epicForm.querySelector('input[name="title"]').focus();
            }
        })
        .catch(function(err) {
            console.error('Error creating epic:', err);
        });
    });
}

function escapeHtml(text) {
    var div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Activity filtering
var filterSystem = document.getElementById('filter-system');
var filterUser = document.getElementById('filter-user');
var activityList = document.getElementById('activity-list');

function updateActivityFilter() {
    if (!activityList) return;
    var showSystem = filterSystem.checked;
    var showUser = filterUser.checked;
    
    activityList.querySelectorAll('.update').forEach(function(update) {
        var updateType = update.getAttribute('data-update-type');
        if ((updateType === 'system' && showSystem) || (updateType === 'user' && showUser)) {
            update.style.display = '';
        } else {
            update.style.display = 'none';
        }
    });
}

if (filterSystem) filterSystem.addEventListener('change', updateActivityFilter);
if (filterUser) filterUser.addEventListener('change', updateActivityFilter);
</script>
{% endblock %}
