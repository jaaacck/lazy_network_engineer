{% extends "pm/base.html" %}
{% load markdown_extras %}

{% block content %}
<div class="breadcrumb">
    <a href="{% url 'project_list' %}">projects</a> &gt;
    <a href="{% url 'project_detail' project=project %}">{{ project_title }}</a>{% if epic %} &gt;
    <a href="{% url 'epic_detail' project=project epic=epic %}">{{ epic_title }}</a>{% endif %} &gt;
    {% if epic %}
    <a href="{% url 'task_detail' project=project epic=epic task=task %}">{{ task_title }}</a>
    {% else %}
    <a href="{% url 'task_detail_no_epic' project=project task=task %}">{{ task_title }}</a>
    {% endif %} &gt;
    {{ metadata.title }}
</div>

<div class="page-title">
    <span>{% if metadata.seq_id %}<span class="seq-id">{{ metadata.seq_id }}</span>{% endif %}{{ metadata.title }}</span>
    <div class="mode-toggle">
        <button class="move-subtask-button" id="move-subtask-button">Move</button>
    </div>
</div>

<!-- Subtask Overview -->
<div class="task-overview">
    <div class="overview-row overview-main">
        <div class="overview-field">
            <span class="field-label">Status</span>
            <form method="post" class="field-value status-reason-form" data-auto-submit="true">
                {% csrf_token %}
                <input type="hidden" name="quick_update" value="status">
                <select name="status" class="badge badge-status status-{{ metadata.status }} status-reason-select">
                    {% for status in all_statuses %}
                    <option value="{{ status.name }}" data-requires-reason="{% if status.pending_reason %}1{% else %}0{% endif %}" {% if metadata.status == status.name %}selected{% endif %}>{{ status.display_name }}</option>
                    {% endfor %}
                </select>
                <input type="text" name="pending_reason" class="pending-reason-input" placeholder="Reason..." value="{{ metadata.pending_reason|default:'' }}" style="display: none; margin-left: 6px; padding: 2px 6px; font-size: 12px;">
                <button type="submit" class="pending-reason-save" style="display: none; margin-left: 6px;">Save</button>
            </form>
        </div>
        <div class="overview-field">
            <span class="field-label">Priority</span>
            <form method="post" class="field-value">
                {% csrf_token %}
                <input type="hidden" name="quick_update" value="priority">
                <select name="priority" class="badge badge-priority priority-{{ metadata.priority|default:'none' }}" onchange="this.form.submit()">
                    <option value="">None</option>
                    <option value="1" {% if metadata.priority == 1 %}selected{% endif %}>P1</option>
                    <option value="2" {% if metadata.priority == 2 %}selected{% endif %}>P2</option>
                    <option value="3" {% if metadata.priority == 3 %}selected{% endif %}>P3</option>
                    <option value="4" {% if metadata.priority == 4 %}selected{% endif %}>P4</option>
                    <option value="5" {% if metadata.priority == 5 %}selected{% endif %}>P5</option>
                </select>
            </form>
        </div>
        {% if checklist_total > 0 %}
        <div class="overview-field overview-progress">
            <span class="field-label">Progress</span>
            <div class="field-value">
                <div class="progress-inline">
                    <div class="progress-bar" style="width: {{ checklist_progress }}%"></div>
                </div>
                <span class="progress-text">{{ checklist_progress }}%</span>
            </div>
        </div>
        {% endif %}
        <div class="overview-field overview-created">
            <span class="field-label">Created</span>
            <span class="field-value">{{ metadata.created }}</span>
        </div>
    </div>
    
    <div class="overview-row overview-tags">
        <div class="overview-field overview-field-wide">
            <span class="field-label">Labels</span>
            <div class="field-value tag-chips">
                {% for label in labels %}
                <span class="label-chip" style="background: {{ label.color }}20; border-color: {{ label.color }}; color: {{ label.color }};">
                    <a href="{% url 'search' %}?q={{ label.name|urlencode }}">{{ label.name }}</a>
                    <form method="post" class="chip-remove">{% csrf_token %}<input type="hidden" name="quick_update" value="remove_label"><input type="hidden" name="label" value="{{ label.name }}"><button type="submit">×</button></form>
                </span>
                {% endfor %}
                <div class="searchable-select tag-select">
                    <input type="text" class="tag-search" placeholder="+ Add" data-target="labels-list">
                    <div class="tag-dropdown" id="labels-list">
                        {% for lbl in all_labels %}
                        {% if lbl not in labels_names %}
                        <form method="post" class="tag-option" data-search="{{ lbl }}">
                            {% csrf_token %}
                            <input type="hidden" name="quick_update" value="add_label">
                            <input type="hidden" name="label" value="{{ lbl }}">
                            <button type="submit">{{ lbl }}</button>
                        </form>
                        {% endif %}
                        {% endfor %}
                        <form method="post" class="tag-option tag-create hidden" data-search="">
                            {% csrf_token %}
                            <input type="hidden" name="quick_update" value="add_label">
                            <input type="hidden" name="label" value="" class="new-tag-value">
                            <button type="submit">+ Create "<span class="new-tag-name"></span>"</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <div class="overview-field overview-field-wide">
            <span class="field-label">People</span>
            <div class="field-value tag-chips">
                {% for person in people %}
                <span class="people-chip" style="background: {{ person.color }}20; border-color: {{ person.color }}; color: {{ person.color }};">
                    {% if person.id %}<a href="{% url 'person_detail' person_id=person.id %}">{{ person.name }}</a>{% else %}{{ person.name }}{% endif %}
                    <form method="post" class="chip-remove">{% csrf_token %}<input type="hidden" name="quick_update" value="remove_person"><input type="hidden" name="person" value="{{ person.name }}"><button type="submit">×</button></form>
                </span>
                {% endfor %}
                <div class="searchable-select tag-select">
                    <input type="text" class="tag-search" placeholder="+ Add" data-target="people-list">
                    <div class="tag-dropdown" id="people-list">
                        {% for p in all_people %}
                        {% if p not in people_names %}
                        <form method="post" class="tag-option" data-search="{{ p }}">
                            {% csrf_token %}
                            <input type="hidden" name="quick_update" value="add_person">
                            <input type="hidden" name="person" value="{{ p }}">
                            <button type="submit">{{ p }}</button>
                        </form>
                        {% endif %}
                        {% endfor %}
                        <form method="post" class="tag-option tag-create hidden" data-search="">
                            {% csrf_token %}
                            <input type="hidden" name="quick_update" value="add_person">
                            <input type="hidden" name="person" value="" class="new-tag-value">
                            <button type="submit">+ Create "<span class="new-tag-name"></span>"</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="overview-row overview-description" id="description-container" style="position: relative;{% if not content %} display: none;{% endif %}">
        <button class="description-edit-btn" id="description-edit-btn" style="position: absolute; top: 8px; right: 8px;">edit</button>
        <div class="overview-field overview-field-full">
            <span class="field-label">Description</span>
            <div class="field-value content" id="description-display">
                {% if content %}{{ content|markdownify|safe }}{% else %}<span style="color: #828282;">No description</span>{% endif %}
            </div>
            <div id="description-editor-container" style="display: none; margin-top: 10px;">
                <textarea id="description-editor">{% if content %}{{ content }}{% endif %}</textarea>
                <div class="description-actions" style="margin-top: 10px;">
                    <button type="button" id="description-save-btn">Save</button>
                    <button type="button" id="description-cancel-btn">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    {% if not content %}
    <div class="overview-row" id="description-add-row">
        <div class="overview-field overview-field-wide">
            <button class="description-add-btn" id="description-add-btn" style="padding: 10px 16px; background: transparent; border: 2px dashed #d0d0d0; border-radius: 4px; cursor: pointer; font-size: 14px; width: 100%; text-align: left; color: #666;">+ Add description</button>
        </div>
    </div>
    {% endif %}

    {% if not is_inbox_subtask %}
    {% with blocks_count=blocks|length blocked_count=blocked_by|length %}
    <!-- Actions & Relationships (ultra-minimal) -->
    <details class="section compact-section" style="margin-top: 8px; margin-bottom: 8px;"{% if blocks or blocked_by or show_actions_success %} open{% endif %}>
        <summary class="section-title" style="padding: 4px 0; font-size: 13px;">Actions & Relationships{% if blocks or blocked_by %} ({{ blocks_count|add:blocked_count }}){% endif %}</summary>
        <div style="font-size: 12px; line-height: 1.3;">
            {% if available_tasks %}
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;">
                <div>
                    <div style="font-weight: bold; font-size: 11px; margin-bottom: 2px;">Blocks</div>
                    <div class="searchable-select">
                        <input type="text" class="dep-search" placeholder="Add..." data-target="blocks-list" style="font-size: 11px; padding: 2px 4px; width: 100%;">
                        <div class="dep-dropdown" id="blocks-list" style="font-size: 11px;">
                            {% for t in available_tasks %}
                            <form method="post" class="dep-option" data-search="{{ t.seq_id }} {{ t.title }}">
                                {% csrf_token %}
                                <input type="hidden" name="add_block" value="{{ t.id }}">
                                <button type="submit" style="font-size: 11px; padding: 2px;">
                                    {% if t.seq_id %}<span class="seq-id">{{ t.seq_id }}</span>{% endif %} {{ t.title|truncatewords:3 }}
                                </button>
                            </form>
                            {% endfor %}
                        </div>
                    </div>
                    {% if blocks %}
                    <div style="margin-top: 4px;">
                        {% for block in blocks %}
                        <div style="padding: 3px 4px; margin-bottom: 3px; border-left: 2px solid #e0e0e0; display: flex; justify-content: space-between; align-items: flex-start; gap: 4px;">
                            <div style="flex: 1; min-width: 0;">
                                {% if block.type == 'subtask' %}
                                <a href="{% url 'subtask_detail' project=project epic=block.epic_id task=block.task_id subtask=block.id %}" style="font-size: 11px; text-decoration: none; color: #333;">
                                    {% if block.seq_id %}<span class="seq-id" style="font-weight: bold;">{{ block.seq_id }}</span>{% endif %} {{ block.title }}
                                </a>
                                {% else %}
                                <a href="{% url 'task_detail' project=project epic=block.epic_id task=block.id %}" style="font-size: 11px; text-decoration: none; color: #333;">
                                    {% if block.seq_id %}<span class="seq-id" style="font-weight: bold;">{{ block.seq_id }}</span>{% endif %} {{ block.title }}
                                </a>
                                {% endif %}
                                <div style="font-size: 10px; color: #666; margin-top: 2px; display: flex; gap: 6px; flex-wrap: wrap;">
                                    <span class="badge badge-status status-{{ block.status }}" style="font-size: 9px; padding: 1px 3px;">{{ block.status }}</span>
                                    {% if block.priority %}<span style="background: #f0f0f0; padding: 1px 3px; border-radius: 2px;">P{{ block.priority }}</span>{% endif %}
                                    {% if block.epic_title %}<span style="color: #999;">{{ block.epic_title }}</span>{% endif %}
                                </div>
                            </div>
                            <form method="post" class="dep-remove" style="display: inline; margin: 0; flex-shrink: 0;">{% csrf_token %}<input type="hidden" name="remove_block" value="{{ block.id }}"><button type="submit" style="font-size: 11px; padding: 2px 4px; border: none; background: #f0f0f0; color: #d00; cursor: pointer; border-radius: 2px;">×</button></form>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
                <div>
                    <div style="font-weight: bold; font-size: 11px; margin-bottom: 2px;">Blocked by</div>
                    <div class="searchable-select">
                        <input type="text" class="dep-search" placeholder="Add..." data-target="blocked-by-list" style="font-size: 11px; padding: 2px 4px; width: 100%;">
                        <div class="dep-dropdown" id="blocked-by-list" style="font-size: 11px;">
                            {% for t in available_tasks %}
                            <form method="post" class="dep-option" data-search="{{ t.seq_id }} {{ t.title }}">
                                {% csrf_token %}
                                <input type="hidden" name="add_blocked_by" value="{{ t.id }}">
                                <button type="submit" style="font-size: 11px; padding: 2px;">
                                    {% if t.seq_id %}<span class="seq-id">{{ t.seq_id }}</span>{% endif %} {{ t.title|truncatewords:3 }}
                                </button>
                            </form>
                            {% endfor %}
                        </div>
                    </div>
                    {% if blocked_by %}
                    <div style="margin-top: 4px;">
                        {% for blocker in blocked_by %}
                        <div style="padding: 3px 4px; margin-bottom: 3px; border-left: 2px solid #e0e0e0; display: flex; justify-content: space-between; align-items: flex-start; gap: 4px;">
                            <div style="flex: 1; min-width: 0;">
                                {% if blocker.type == 'subtask' %}
                                <a href="{% url 'subtask_detail' project=project epic=blocker.epic_id task=blocker.task_id subtask=blocker.id %}" style="font-size: 11px; text-decoration: none; color: #333;">
                                    {% if blocker.seq_id %}<span class="seq-id" style="font-weight: bold;">{{ blocker.seq_id }}</span>{% endif %} {{ blocker.title }}
                                </a>
                                {% else %}
                                <a href="{% url 'task_detail' project=project epic=blocker.epic_id task=blocker.id %}" style="font-size: 11px; text-decoration: none; color: #333;">
                                    {% if blocker.seq_id %}<span class="seq-id" style="font-weight: bold;">{{ blocker.seq_id }}</span>{% endif %} {{ blocker.title }}
                                </a>
                                {% endif %}
                                <div style="font-size: 10px; color: #666; margin-top: 2px; display: flex; gap: 6px; flex-wrap: wrap;">
                                    <span class="badge badge-status status-{{ blocker.status }}" style="font-size: 9px; padding: 1px 3px;">{{ blocker.status }}</span>
                                    {% if blocker.priority %}<span style="background: #f0f0f0; padding: 1px 3px; border-radius: 2px;">P{{ blocker.priority }}</span>{% endif %}
                                    {% if blocker.epic_title %}<span style="color: #999;">{{ blocker.epic_title }}</span>{% endif %}
                                </div>
                            </div>
                            <form method="post" class="dep-remove" style="display: inline; margin: 0; flex-shrink: 0;">{% csrf_token %}<input type="hidden" name="remove_blocked_by" value="{{ blocker.id }}"><button type="submit" style="font-size: 11px; padding: 2px 4px; border: none; background: #f0f0f0; color: #d00; cursor: pointer; border-radius: 2px;">×</button></form>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
    </details>
    {% endwith %}
    {% endif %}
</div>

    <!-- Checklist Section -->
    <details class="section checklist-section"{% if metadata.checklist %} open{% endif %}>
        <summary class="section-title">Checklist{% if metadata.checklist %} ({{ metadata.checklist|length }}){% endif %}</summary>
        {% if metadata.checklist %}
            <div class="item-list">
                {% for item in metadata.checklist %}
                <div class="checklist-item {% if item.status == 'done' %}done{% endif %}">
                    <form method="post" class="form-contents">
                        {% csrf_token %}
                        <input type="hidden" name="checklist_toggle_id" value="{{ item.id }}">
                        <input type="checkbox" onchange="this.form.submit()" {% if item.status == 'done' %}checked{% endif %}>
                    </form>
                    <span class="checklist-title">{{ item.title }}</span>
                    <div class="checklist-actions">
                        <form method="post" class="form-inline">
                            {% csrf_token %}
                            <input type="hidden" name="checklist_delete_id" value="{{ item.id }}">
                            <button type="submit" class="delete">delete</button>
                        </form>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="empty">No checklist items yet.</div>
        {% endif %}

        <form method="post" class="checklist-add">
            {% csrf_token %}
            <input type="text" name="checklist_add_title" placeholder="Add checklist item..." required>
            <button type="submit">Add</button>
        </form>
    </details>

    <!-- Notes Section -->
    <details class="section compact-section"{% if associated_notes %} open{% endif %}>
        <summary class="section-title">Notes{% if associated_notes %} ({{ associated_notes|length }}){% endif %}</summary>
        <div class="notes-section">
            <div class="searchable-select note-select">
                <input type="text" class="note-search" placeholder="Search notes to link..." data-target="notes-list">
                <div class="note-dropdown" id="notes-list">
                    {% for note in available_notes %}
                    <form method="post" class="note-option" data-search="{{ note.title }}">
                        {% csrf_token %}
                        <input type="hidden" name="quick_update" value="add_note">
                        <input type="hidden" name="note_id" value="{{ note.id }}">
                        <button type="submit">{{ note.title }}</button>
                    </form>
                    {% empty %}
                    <div class="empty-option">No notes available</div>
                    {% endfor %}
                </div>
            </div>
            {% if associated_notes %}
            <div class="notes-list">
                {% for note in associated_notes %}
                <div class="note-item">
                    <div class="note-info">
                        <a href="{% url 'note_detail' note_id=note.id %}">{{ note.title }}</a>
                        {% if note.preview %}<span class="note-preview">{{ note.preview }}...</span>{% endif %}
                    </div>
                    <form method="post" class="note-remove">
                        {% csrf_token %}
                        <input type="hidden" name="quick_update" value="remove_note">
                        <input type="hidden" name="note_id" value="{{ note.id }}">
                        <button type="submit" class="delete-inline">×</button>
                    </form>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty">No notes linked yet.</div>
            {% endif %}
        </div>
    </details>

    <div class="section">
        <div class="section-title">Activity</div>
        <div class="activity-filters">
            <label>
                <input type="checkbox" id="filter-system"> System messages
            </label>
            <label>
                <input type="checkbox" id="filter-user" checked> User messages
            </label>
        </div>
        
        <form method="post" class="update-form" id="update-form">
            {% csrf_token %}
            <textarea name="update_content" id="update_content" placeholder="Add update..." required></textarea>
            <button type="submit" id="update-submit-btn" class="update-submit-btn">Post Update</button>
        </form>
        
        {% if updates %}
        <div id="activity-list">
        {% for update in updates %}
        <div class="update update-{{ update.type|default:'user' }}" data-update-type="{{ update.type|default:'user' }}" data-update-timestamp="{{ update.timestamp|date:'Y-m-d H:i' }}" id="update-{{ forloop.counter }}">
            <div class="update-meta">
                <span class="update-timestamp">{{ update.timestamp|date:"Y-m-d H:i" }}</span>
                {% if update.type == 'system' %}
                <span class="update-type-badge">system</span>
                {% else %}
                <span class="update-type-badge">user</span>
                <button class="update-edit-btn" data-update-id="update-{{ forloop.counter }}" title="Edit update">edit</button>
                {% endif %}
            </div>
            <div class="update-content content" id="update-display-{{ forloop.counter }}">{{ update.content|markdownify|safe }}</div>
            <div class="update-editor-container" id="update-editor-container-{{ forloop.counter }}" style="display: none; margin-top: 10px;">
                <textarea class="update-editor" id="update-editor-{{ forloop.counter }}">{{ update.content }}</textarea>
                <div class="update-actions" style="margin-top: 10px;">
                    <button type="button" class="update-save-btn" data-update-id="update-{{ forloop.counter }}">Save</button>
                    <button type="button" class="update-cancel-btn" data-update-id="update-{{ forloop.counter }}">Cancel</button>
                </div>
            </div>
        </div>
        {% endfor %}
        </div>
        {% else %}
        <div class="empty">No activity yet.</div>
        {% endif %}
    </div>
{% endblock %}

{% block scripts %}
<script>
    // Auto-submit schedule forms
    var quickStart = document.getElementById('quick_schedule_start');
    if (quickStart) {
        quickStart.addEventListener('change', function() {
            var form = document.getElementById('schedule-start-form');
            if (form) form.submit();
        });
    }
    
    var quickEnd = document.getElementById('quick_schedule_end');
    if (quickEnd) {
        quickEnd.addEventListener('change', function() {
            var form = document.getElementById('schedule-end-form');
            if (form) form.submit();
        });
    }

    var quickDue = document.getElementById('quick_due_date');
    if (quickDue) {
        quickDue.addEventListener('change', function() {
            var form = document.getElementById('due-date-form');
            if (form) form.submit();
        });
    }
    
    // Initialize EasyMDE for update editor
    var updateEditor = null;
    var updateTextarea = document.getElementById('update_content');
    var updateForm = document.getElementById('update-form');
    
    if (updateTextarea && updateForm) {
        updateEditor = new EasyMDE({
            element: updateTextarea,
            spellChecker: false,
            toolbar: ['bold', 'italic', 'heading', '|', 'quote', 'unordered-list', 'ordered-list', '|', 'link', 'image', 'code', 'table', '|', 'preview', 'side-by-side', 'fullscreen', '|', 'guide'],
            minHeight: '150px',
            placeholder: 'Add update... (Markdown supported)',
            status: false,
            autosave: {
                enabled: false
            }
        });

        // Keep textarea value in sync for required validation
        updateEditor.codemirror.on('change', function() {
            updateTextarea.value = updateEditor.value();
        });
        
        // Initialize @mention autocomplete for update editor
        initMentionAutocomplete(updateEditor);
        
        // Handle clipboard image paste (Ctrl+V)
        updateEditor.codemirror.on('paste', function(cm, e) {
            var clipboardData = e.clipboardData || window.clipboardData;
            if (!clipboardData) return;
            
            var items = clipboardData.items;
            if (!items) return;
            
            // Check if clipboard contains image
            for (var i = 0; i < items.length; i++) {
                if (items[i].type.indexOf('image') !== -1) {
                    e.preventDefault();
                    var file = items[i].getAsFile();
                    
                    // Show loading indicator
                    var cursor = cm.getCursor();
                    var loadingText = '![Uploading image...]()';
                    cm.replaceRange(loadingText, cursor);
                    
                    // Upload image
                    var formData = new FormData();
                    formData.append('image', file);
                    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
                    
                    fetch('{% url "upload_image" %}', {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    })
                    .then(function(response) {
                        return response.json();
                    })
                    .then(function(data) {
                        if (data.success) {
                            // Replace loading text with markdown image
                            var markdownImage = '![' + file.name + '](' + data.url + ')';
                            var content = cm.getValue();
                            content = content.replace(loadingText, markdownImage);
                            cm.setValue(content);
                            updateTextarea.value = content;
                        } else {
                            // Replace loading text with error message
                            var errorText = '![Image upload failed: ' + (data.error || 'Unknown error') + ']()';
                            var content = cm.getValue();
                            content = content.replace(loadingText, errorText);
                            cm.setValue(content);
                            updateTextarea.value = content;
                        }
                    })
                    .catch(function(err) {
                        // Replace loading text with error message
                        var errorText = '![Image upload failed: Network error]()';
                        var content = cm.getValue();
                        content = content.replace(loadingText, errorText);
                        cm.setValue(content);
                        updateTextarea.value = content;
                    });
                    
                    return;
                }
            }
        });
        
        // Ensure textarea value is synced before form submission
        updateForm.addEventListener('submit', function(e) {
            if (updateEditor) {
                // Sync EasyMDE value back to textarea
                var editorValue = updateEditor.value();
                updateTextarea.value = editorValue;
                
                // Make sure textarea is visible and has value
                if (!updateTextarea.value || updateTextarea.value.trim() === '') {
                    e.preventDefault();
                    alert('Please enter an update before posting.');
                    return false;
                }
            }
        });
        
        // Also sync on button click as backup
        var submitBtn = document.getElementById('update-submit-btn');
        if (submitBtn) {
            submitBtn.addEventListener('click', function(e) {
                if (updateEditor) {
                    updateTextarea.value = updateEditor.value();
                }
            });
        }
    }

    // Searchable dependency dropdowns
    document.querySelectorAll('.dep-search').forEach(function(input) {
        var targetId = input.getAttribute('data-target');
        var dropdown = document.getElementById(targetId);
        
        input.addEventListener('input', function() {
            var query = input.value.toLowerCase();
            dropdown.querySelectorAll('.dep-option').forEach(function(opt) {
                var searchText = opt.getAttribute('data-search').toLowerCase();
                if (searchText.includes(query)) {
                    opt.classList.remove('hidden');
                } else {
                    opt.classList.add('hidden');
                }
            });
        });
        
        input.addEventListener('focus', function() {
            dropdown.style.display = 'block';
        });
        
        input.addEventListener('blur', function() {
            // Delay hide to allow click on dropdown
            setTimeout(function() {
                dropdown.style.display = 'none';
            }, 200);
        });
    });

    // Searchable tag dropdowns (labels and people)
    document.querySelectorAll('.tag-search').forEach(function(input) {
        var targetId = input.getAttribute('data-target');
        var dropdown = document.getElementById(targetId);
        var createOption = dropdown ? dropdown.querySelector('.tag-create') : null;
        
        if (!dropdown) return;
        
        input.addEventListener('input', function() {
            var query = input.value.toLowerCase().trim();
            var hasExactMatch = false;
            var visibleOptions = 0;
            
            // Show/hide existing options
            dropdown.querySelectorAll('.tag-option:not(.tag-create)').forEach(function(opt) {
                var searchText = opt.getAttribute('data-search') || '';
                searchText = searchText.toLowerCase();
                if (query && searchText.includes(query)) {
                    opt.classList.remove('hidden');
                    visibleOptions++;
                    if (searchText === query) hasExactMatch = true;
                } else if (query) {
                    opt.classList.add('hidden');
                } else {
                    // Show all when query is empty
                    opt.classList.remove('hidden');
                    visibleOptions++;
                }
            });
            
            // Show/hide create option
            if (createOption) {
                if (query && !hasExactMatch) {
                    createOption.classList.remove('hidden');
                    var nameSpan = createOption.querySelector('.new-tag-name');
                    var valueInput = createOption.querySelector('.new-tag-value');
                    if (nameSpan) nameSpan.textContent = input.value;
                    if (valueInput) valueInput.value = input.value;
                } else if (query && visibleOptions === 0) {
                    // Show create option if no matches found
                    createOption.classList.remove('hidden');
                    var nameSpan = createOption.querySelector('.new-tag-name');
                    var valueInput = createOption.querySelector('.new-tag-value');
                    if (nameSpan) nameSpan.textContent = input.value;
                    if (valueInput) valueInput.value = input.value;
                } else {
                    createOption.classList.add('hidden');
                }
            }
        });
        
        input.addEventListener('focus', function() {
            dropdown.style.display = 'block';
            // Show create option if there's text and no exact match
            if (createOption && input.value.trim()) {
                var query = input.value.toLowerCase().trim();
                var hasExactMatch = false;
                dropdown.querySelectorAll('.tag-option:not(.tag-create)').forEach(function(opt) {
                    var searchText = (opt.getAttribute('data-search') || '').toLowerCase();
                    if (searchText === query) hasExactMatch = true;
                });
                if (!hasExactMatch) {
                    createOption.classList.remove('hidden');
                    var nameSpan = createOption.querySelector('.new-tag-name');
                    var valueInput = createOption.querySelector('.new-tag-value');
                    if (nameSpan) nameSpan.textContent = input.value;
                    if (valueInput) valueInput.value = input.value;
                }
            }
        });
        
        input.addEventListener('blur', function() {
            setTimeout(function() {
                dropdown.style.display = 'none';
            }, 200);
        });
    });

    // Searchable note dropdown
    document.querySelectorAll('.note-search').forEach(function(input) {
        var targetId = input.getAttribute('data-target');
        var dropdown = document.getElementById(targetId);
        
        input.addEventListener('input', function() {
            var query = input.value.toLowerCase();
            dropdown.querySelectorAll('.note-option').forEach(function(opt) {
                var searchText = opt.getAttribute('data-search').toLowerCase();
                if (searchText.includes(query)) {
                    opt.classList.remove('hidden');
                } else {
                    opt.classList.add('hidden');
                }
            });
        });
        
        input.addEventListener('focus', function() {
            dropdown.style.display = 'block';
        });
        
        input.addEventListener('blur', function() {
            setTimeout(function() {
                dropdown.style.display = 'none';
            }, 200);
        });
    });

    // Activity filtering
    var filterSystem = document.getElementById('filter-system');
    var filterUser = document.getElementById('filter-user');
    var activityList = document.getElementById('activity-list');
    
    function updateActivityFilter() {
        if (!activityList || !filterSystem || !filterUser) return;
        var showSystem = filterSystem.checked;
        var showUser = filterUser.checked;
        
        activityList.querySelectorAll('.update').forEach(function(update) {
            var updateType = update.getAttribute('data-update-type');
            if ((updateType === 'system' && showSystem) || (updateType === 'user' && showUser)) {
                update.style.display = '';
            } else {
                update.style.display = 'none';
            }
        });
    }
    
    if (filterSystem) filterSystem.addEventListener('change', updateActivityFilter);
    if (filterUser) filterUser.addEventListener('change', updateActivityFilter);
    updateActivityFilter(); // Apply filter on page load

    // Update editor handling
    var updateEditors = {};
    var originalUpdateContent = {};
    
    document.querySelectorAll('.update-edit-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            var updateId = btn.getAttribute('data-update-id');
            var updateContainer = document.getElementById(updateId);
            var updateDisplay = document.getElementById('update-display-' + updateId.split('-')[1]);
            var updateEditorContainer = document.getElementById('update-editor-container-' + updateId.split('-')[1]);
            var updateEditor = document.getElementById('update-editor-' + updateId.split('-')[1]);
            
            // Hide display and show editor
            updateDisplay.style.display = 'none';
            updateEditorContainer.style.display = 'block';
            
            // Initialize EasyMDE if not already initialized for this update
            if (!updateEditors[updateId]) {
                updateEditors[updateId] = new EasyMDE({
                    element: updateEditor,
                    spellChecker: false,
                    toolbar: ['bold', 'italic', 'heading', '|', 'quote', 'unordered-list', 'ordered-list', '|', 'link', 'image', 'code', 'table', '|', 'preview', 'side-by-side', 'fullscreen', '|', 'guide'],
                    minHeight: '100px',
                    placeholder: 'Edit update... (Markdown supported)',
                    status: false,
                    autosave: {
                        enabled: false
                    }
                });
                originalUpdateContent[updateId] = updateEditors[updateId].value();
            } else {
                updateEditors[updateId].value(originalUpdateContent[updateId]);
            }
        });
    });
    
    document.querySelectorAll('.update-save-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            var updateId = btn.getAttribute('data-update-id');
            var updateNumber = updateId.split('-')[1];
            var updateEditor = updateEditors[updateId];
            var newContent = updateEditor ? updateEditor.value() : document.getElementById('update-editor-' + updateNumber).value;
            var timestamp = document.getElementById(updateId).getAttribute('data-update-timestamp');
            
            if (!newContent || newContent.trim() === '') {
                alert('Update cannot be empty.');
                return;
            }
            
            var formData = new FormData();
            formData.append('quick_update', 'edit_update');
            formData.append('update_timestamp', timestamp);
            formData.append('update_content', newContent);
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
            
            var url = '{% if epic %}{% url "subtask_detail" project=project epic=epic task=task subtask=subtask %}{% else %}{% url "subtask_detail_no_epic" project=project task=task subtask=subtask %}{% endif %}';
            fetch(url, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(function(response) { return response.json(); })
            .then(function(data) {
                if (data.success) {
                    // Update display with new content
                    document.getElementById('update-display-' + updateNumber).innerHTML = data.content;
                    originalUpdateContent[updateId] = newContent;
                    
                    // Switch back to view mode
                    document.getElementById('update-editor-container-' + updateNumber).style.display = 'none';
                    document.getElementById('update-display-' + updateNumber).style.display = 'block';
                } else {
                    alert('Error: ' + (data.error || 'Failed to update'));
                }
            })
            .catch(function(err) {
                console.error('Error saving update:', err);
                alert('Error saving update');
            });
        });
    });
    
    document.querySelectorAll('.update-cancel-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            var updateId = btn.getAttribute('data-update-id');
            var updateNumber = updateId.split('-')[1];
            var updateEditor = updateEditors[updateId];
            
            // Restore original content
            if (updateEditor) {
                updateEditor.value(originalUpdateContent[updateId]);
            }
            
            // Switch back to view mode
            document.getElementById('update-editor-container-' + updateNumber).style.display = 'none';
            document.getElementById('update-display-' + updateNumber).style.display = 'block';
        });
    });
</script>

<!-- Move Subtask Modal -->
<div class="help-modal" id="move-subtask-modal">
    <div class="help-modal-content">
        <div class="help-modal-header">
            <h3>Move Subtask</h3>
            <button class="help-modal-close" id="move-subtask-close">&times;</button>
        </div>
        <div class="help-content">
            <form id="move-subtask-form">
                <div class="form-group">
                    <label for="move-target-project">Project</label>
                    <select name="target_project" id="move-target-project" required>
                        <option value="">Select Project...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="move-target-epic">Epic (optional)</label>
                    <select name="target_epic" id="move-target-epic">
                        <option value="">None (Direct Task)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="move-target-task">Task</label>
                    <select name="target_task" id="move-target-task" required disabled>
                        <option value="">Select Task...</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="submit">Move Subtask</button>
                    <button type="button" id="move-subtask-cancel">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Move Subtask Modal
var moveSubtaskButton = document.getElementById('move-subtask-button');
var moveSubtaskModal = document.getElementById('move-subtask-modal');
var moveSubtaskClose = document.getElementById('move-subtask-close');
var moveSubtaskCancel = document.getElementById('move-subtask-cancel');
var moveSubtaskForm = document.getElementById('move-subtask-form');
var moveTargetProject = document.getElementById('move-target-project');
var moveTargetEpic = document.getElementById('move-target-epic');
var moveTargetTask = document.getElementById('move-target-task');
var projectsLoaded = false;

if (moveSubtaskButton && moveSubtaskModal) {
    moveSubtaskButton.addEventListener('click', function(e) {
        e.preventDefault();
        moveSubtaskModal.classList.add('show');
        
        // Load projects and tasks if not already loaded
        if (!projectsLoaded) {
            var url = '{% if epic %}{% url "move_subtask" project=project epic=epic task=task subtask=subtask %}{% else %}{% url "move_subtask_no_epic" project=project task=task subtask=subtask %}{% endif %}';
            fetch(url, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(function(response) { return response.json(); })
            .then(function(data) {
                if (data.projects) {
                    moveTargetProject.innerHTML = '<option value="">Select Project...</option>';
                    data.projects.forEach(function(project) {
                        var option = document.createElement('option');
                        option.value = project.id;
                        option.textContent = project.title;
                        option.dataset.epics = JSON.stringify(project.epics || []);
                        option.dataset.directTasks = JSON.stringify(project.direct_tasks || []);
                        moveTargetProject.appendChild(option);
                    });
                    projectsLoaded = true;
                }
            })
            .catch(function(err) {
                alert('Error loading projects: ' + err.message);
            });
        }
    });
    
    if (moveSubtaskClose) {
        moveSubtaskClose.addEventListener('click', function(e) {
            e.stopPropagation();
            moveSubtaskModal.classList.remove('show');
        });
    }
    
    if (moveSubtaskCancel) {
        moveSubtaskCancel.addEventListener('click', function(e) {
            e.preventDefault();
            moveSubtaskModal.classList.remove('show');
        });
    }
    
    // Update epics and tasks when project changes
    if (moveTargetProject) {
        moveTargetProject.addEventListener('change', function() {
            var selectedOption = this.options[this.selectedIndex];
            var epics = selectedOption.dataset.epics ? JSON.parse(selectedOption.dataset.epics) : [];
            var directTasks = selectedOption.dataset.directTasks ? JSON.parse(selectedOption.dataset.directTasks) : [];
            
            // Update epics dropdown
            moveTargetEpic.innerHTML = '<option value="">None (Direct Task)</option>';
            epics.forEach(function(epic) {
                var option = document.createElement('option');
                option.value = epic.id;
                option.textContent = (epic.seq_id ? epic.seq_id + ' ' : '') + epic.title;
                option.dataset.tasks = JSON.stringify(epic.tasks || []);
                moveTargetEpic.appendChild(option);
            });
            
            // Update tasks dropdown with direct tasks
            moveTargetTask.innerHTML = '<option value="">Select Task...</option>';
            directTasks.forEach(function(task) {
                var option = document.createElement('option');
                option.value = task.id;
                option.textContent = (task.seq_id ? task.seq_id + ' ' : '') + task.title;
                moveTargetTask.appendChild(option);
            });
            moveTargetTask.disabled = directTasks.length === 0 && epics.length === 0;
            
            // Trigger epic change to load epic tasks
            if (epics.length > 0) {
                moveTargetEpic.dispatchEvent(new Event('change'));
            }
        });
    }
    
    // Update tasks when epic changes
    if (moveTargetEpic) {
        moveTargetEpic.addEventListener('change', function() {
            var selectedOption = this.options[this.selectedIndex];
            var tasks = selectedOption.dataset.tasks ? JSON.parse(selectedOption.dataset.tasks) : [];
            
            moveTargetTask.innerHTML = '<option value="">Select Task...</option>';
            tasks.forEach(function(task) {
                var option = document.createElement('option');
                option.value = task.id;
                option.textContent = (task.seq_id ? task.seq_id + ' ' : '') + task.title;
                moveTargetTask.appendChild(option);
            });
            moveTargetTask.disabled = !tasks.length;
        });
    }
    
    // Handle form submission
    if (moveSubtaskForm) {
        moveSubtaskForm.addEventListener('submit', function(e) {
            e.preventDefault();
            var formData = new FormData(moveSubtaskForm);
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
            
            var url = '{% if epic %}{% url "move_subtask" project=project epic=epic task=task subtask=subtask %}{% else %}{% url "move_subtask_no_epic" project=project task=task subtask=subtask %}{% endif %}';
            fetch(url, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(function(response) { return response.json(); })
            .then(function(data) {
                if (data.success) {
                    // Redirect to new subtask location
                    window.location.href = data.url;
                } else {
                    alert('Error: ' + (data.error || 'Failed to move subtask'));
                }
            })
            .catch(function(err) {
                alert('Error: ' + err.message);
            });
        });
    }
    
    // Close modal when clicking outside
    moveSubtaskModal.addEventListener('click', function(e) {
        if (e.target === moveSubtaskModal) {
            moveSubtaskModal.classList.remove('show');
        }
    });
}

    // Description editing
    var descriptionEditBtn = document.getElementById('description-edit-btn');
    var descriptionAddBtn = document.getElementById('description-add-btn');
    var descriptionAddRow = document.getElementById('description-add-row');
    var descriptionContainer = document.getElementById('description-container');
    var descriptionDisplay = document.getElementById('description-display');
    var descriptionEditorContainer = document.getElementById('description-editor-container');
    var descriptionEditor = document.getElementById('description-editor');
    var descriptionSaveBtn = document.getElementById('description-save-btn');
    var descriptionCancelBtn = document.getElementById('description-cancel-btn');
    var descriptionMDE = null;
    var originalContent = descriptionEditor ? descriptionEditor.value : '';

    // Handle "Add description" button click
    if (descriptionAddBtn) {
        descriptionAddBtn.addEventListener('click', function() {
            // Hide "Add description" row
            if (descriptionAddRow) {
                descriptionAddRow.style.display = 'none';
            }
            
            // Show description container
            if (descriptionContainer) {
                descriptionContainer.style.display = 'block';
            }
            
            // Show editor container
            descriptionEditorContainer.style.display = 'block';
            
            // Initialize EasyMDE if not already initialized
            if (!descriptionMDE && descriptionEditor) {
                descriptionMDE = new EasyMDE({
                    element: descriptionEditor,
                    spellChecker: false,
                    toolbar: ['bold', 'italic', 'heading', '|', 'quote', 'unordered-list', 'ordered-list', '|', 'link', 'image', 'code', 'table', '|', 'preview', 'side-by-side', 'fullscreen', '|', 'guide'],
                    minHeight: '200px',
                    placeholder: 'Enter description... (Markdown supported)',
                    status: false,
                    autosave: {
                        enabled: false
                    }
                });
                originalContent = '';
                
                // Initialize @mention autocomplete for description editor
                initMentionAutocomplete(descriptionMDE);
                
                // Handle clipboard image paste (Ctrl+V)
                descriptionMDE.codemirror.on('paste', function(cm, e) {
                    var clipboardData = e.clipboardData || window.clipboardData;
                    if (!clipboardData) return;
                    
                    var items = clipboardData.items;
                    if (!items) return;
                    
                    // Check if clipboard contains image
                    for (var i = 0; i < items.length; i++) {
                        if (items[i].type.indexOf('image') !== -1) {
                            e.preventDefault();
                            var file = items[i].getAsFile();
                            
                            // Show loading indicator
                            var cursor = cm.getCursor();
                            var loadingText = '![Uploading image...]()';
                            cm.replaceRange(loadingText, cursor);
                            
                            // Upload image
                            var formData = new FormData();
                            formData.append('image', file);
                            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
                            
                            fetch('{% url "upload_image" %}', {
                                method: 'POST',
                                body: formData,
                                headers: {
                                    'X-Requested-With': 'XMLHttpRequest'
                                }
                            })
                            .then(function(response) {
                                return response.json();
                            })
                            .then(function(data) {
                                if (data.success) {
                                    // Replace loading text with markdown image
                                    var markdownImage = '![' + file.name + '](' + data.url + ')';
                                    var content = cm.getValue();
                                    content = content.replace(loadingText, markdownImage);
                                    cm.setValue(content);
                                } else {
                                    // Replace loading text with error message
                                    var errorText = '![Image upload failed: ' + (data.error || 'Unknown error') + ']()';
                                    var content = cm.getValue();
                                    content = content.replace(loadingText, errorText);
                                    cm.setValue(content);
                                }
                            })
                            .catch(function(err) {
                                // Replace loading text with error message
                                var errorText = '![Image upload failed: Network error]()';
                                var content = cm.getValue();
                                content = content.replace(loadingText, errorText);
                                cm.setValue(content);
                            });
                            
                            return;
                        }
                    }
                });
            }
        });
    }

    if (descriptionEditBtn && descriptionEditor) {
        descriptionEditBtn.addEventListener('click', function() {
            // Hide display and edit button
            descriptionDisplay.style.display = 'none';
            descriptionEditBtn.style.display = 'none';
            
            // Show editor container
            descriptionEditorContainer.style.display = 'block';
            
            // Initialize EasyMDE if not already initialized
            if (!descriptionMDE) {
                descriptionMDE = new EasyMDE({
                    element: descriptionEditor,
                    spellChecker: false,
                    toolbar: ['bold', 'italic', 'heading', '|', 'quote', 'unordered-list', 'ordered-list', '|', 'link', 'image', 'code', 'table', '|', 'preview', 'side-by-side', 'fullscreen', '|', 'guide'],
                    minHeight: '200px',
                    placeholder: 'Enter description... (Markdown supported)',
                    status: false,
                    autosave: {
                        enabled: false
                    }
                });
                originalContent = descriptionMDE.value();
                
                // Initialize @mention autocomplete for description editor
                initMentionAutocomplete(descriptionMDE);
                
                // Handle clipboard image paste (Ctrl+V)
                descriptionMDE.codemirror.on('paste', function(cm, e) {
                    var clipboardData = e.clipboardData || window.clipboardData;
                    if (!clipboardData) return;
                    
                    var items = clipboardData.items;
                    if (!items) return;
                    
                    // Check if clipboard contains image
                    for (var i = 0; i < items.length; i++) {
                        if (items[i].type.indexOf('image') !== -1) {
                            e.preventDefault();
                            var file = items[i].getAsFile();
                            
                            // Show loading indicator
                            var cursor = cm.getCursor();
                            var loadingText = '![Uploading image...]()';
                            cm.replaceRange(loadingText, cursor);
                            
                            // Upload image
                            var formData = new FormData();
                            formData.append('image', file);
                            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
                            
                            fetch('{% url "upload_image" %}', {
                                method: 'POST',
                                body: formData,
                                headers: {
                                    'X-Requested-With': 'XMLHttpRequest'
                                }
                            })
                            .then(function(response) {
                                return response.json();
                            })
                            .then(function(data) {
                                if (data.success) {
                                    // Replace loading text with markdown image
                                    var markdownImage = '![' + file.name + '](' + data.url + ')';
                                    var content = cm.getValue();
                                    content = content.replace(loadingText, markdownImage);
                                    cm.setValue(content);
                                } else {
                                    // Replace loading text with error message
                                    var errorText = '![Image upload failed: ' + (data.error || 'Unknown error') + ']()';
                                    var content = cm.getValue();
                                    content = content.replace(loadingText, errorText);
                                    cm.setValue(content);
                                }
                            })
                            .catch(function(err) {
                                // Replace loading text with error message
                                var errorText = '![Image upload failed: Network error]()';
                                var content = cm.getValue();
                                content = content.replace(loadingText, errorText);
                                cm.setValue(content);
                            });
                            
                            return;
                        }
                    }
                });
            } else {
                descriptionMDE.value(originalContent);
            }
        });

        if (descriptionSaveBtn) {
            descriptionSaveBtn.addEventListener('click', function() {
                var content = descriptionMDE ? descriptionMDE.value() : descriptionEditor.value;
                var formData = new FormData();
                formData.append('quick_update', 'description');
                formData.append('description', content);
                formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

                var url = '{% if epic %}{% url "subtask_detail" project=project epic=epic task=task subtask=subtask %}{% else %}{% url "subtask_detail_no_epic" project=project task=task subtask=subtask %}{% endif %}';
                fetch(url, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(function(response) { return response.json(); })
                .then(function(data) {
                    if (data.success) {
                        // Update display with rendered markdown
                        descriptionDisplay.innerHTML = data.content || '<span style="color: #828282;">No description</span>';
                        originalContent = content;
                        
                        // Switch back to view mode
                        descriptionEditorContainer.style.display = 'none';
                        descriptionDisplay.style.display = 'block';
                        descriptionEditBtn.style.display = 'block';
                    } else {
                        alert('Error saving description');
                    }
                })
                .catch(function(err) {
                    console.error('Error saving description:', err);
                    alert('Error saving description');
                });
            });
        }

        if (descriptionCancelBtn) {
            descriptionCancelBtn.addEventListener('click', function() {
                // Restore original content
                if (descriptionMDE) {
                    descriptionMDE.value(originalContent);
                } else {
                    descriptionEditor.value = originalContent;
                }
                
                // Switch back to view mode
                descriptionEditorContainer.style.display = 'none';
                descriptionDisplay.style.display = 'block';
                descriptionEditBtn.style.display = 'block';
            });
        }
    }
</script>
{% endblock %}
