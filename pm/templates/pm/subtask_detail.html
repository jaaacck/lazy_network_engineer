{% extends "pm/base.html" %}
{% load markdown_extras %}

{% block content %}
<div class="breadcrumb">
    <a href="{% url 'project_list' %}">projects</a> &gt;
    <a href="{% url 'project_detail' project=project %}">{{ project_title }}</a> &gt;
    <a href="{% url 'epic_detail' project=project epic=epic %}">{{ epic_title }}</a> &gt;
    <a href="{% url 'task_detail' project=project epic=epic task=task %}">{{ task_title }}</a> &gt;
    {{ metadata.title }}
</div>

<div class="page-title">
    <span>{% if metadata.seq_id %}<span class="seq-id">{{ metadata.seq_id }}</span>{% endif %}{{ metadata.title }}</span>
    <div class="mode-toggle">
        <a href="{% url 'subtask_detail' project=project epic=epic task=task subtask=subtask %}" {% if not edit_mode %}class="active"{% endif %}>view</a>
        <a href="{% url 'subtask_detail' project=project epic=epic task=task subtask=subtask %}?edit=true" {% if edit_mode %}class="active"{% endif %}>edit</a>
    </div>
</div>

<!-- Subtask Overview -->
<div class="task-overview">
    <div class="overview-row overview-main">
        <div class="overview-field">
            <span class="field-label">Status</span>
            <form method="post" class="field-value">
                {% csrf_token %}
                <input type="hidden" name="quick_update" value="status">
                <select name="status" class="badge badge-status status-{{ metadata.status }}" onchange="this.form.submit()">
                    <option value="todo" {% if metadata.status == 'todo' %}selected{% endif %}>todo</option>
                    <option value="in_progress" {% if metadata.status == 'in_progress' %}selected{% endif %}>in progress</option>
                    <option value="done" {% if metadata.status == 'done' %}selected{% endif %}>done</option>
                </select>
            </form>
        </div>
        <div class="overview-field">
            <span class="field-label">Priority</span>
            <form method="post" class="field-value">
                {% csrf_token %}
                <input type="hidden" name="quick_update" value="priority">
                <select name="priority" class="badge badge-priority priority-{{ metadata.priority|default:'none' }}" onchange="this.form.submit()">
                    <option value="">None</option>
                    <option value="1" {% if metadata.priority == '1' %}selected{% endif %}>P1</option>
                    <option value="2" {% if metadata.priority == '2' %}selected{% endif %}>P2</option>
                    <option value="3" {% if metadata.priority == '3' %}selected{% endif %}>P3</option>
                    <option value="4" {% if metadata.priority == '4' %}selected{% endif %}>P4</option>
                    <option value="5" {% if metadata.priority == '5' %}selected{% endif %}>P5</option>
                </select>
            </form>
        </div>
        {% if checklist_total > 0 %}
        <div class="overview-field overview-progress">
            <span class="field-label">Progress</span>
            <div class="field-value">
                <div class="progress-inline">
                    <div class="progress-bar" style="width: {{ checklist_progress }}%"></div>
                </div>
                <span class="progress-text">{{ checklist_progress }}%</span>
            </div>
        </div>
        {% endif %}
        <div class="overview-field overview-created">
            <span class="field-label">Created</span>
            <span class="field-value">{{ metadata.created }}</span>
        </div>
    </div>
    
    <div class="overview-row overview-tags">
        <div class="overview-field overview-field-wide">
            <span class="field-label">Labels</span>
            <div class="field-value tag-chips">
                {% for label in labels %}
                <span class="label-chip" style="background: {{ label.color }}20; border-color: {{ label.color }}; color: {{ label.color }};">
                    <a href="{% url 'search' %}?q={{ label.name|urlencode }}">{{ label.name }}</a>
                    <form method="post" class="chip-remove">{% csrf_token %}<input type="hidden" name="quick_update" value="remove_label"><input type="hidden" name="label" value="{{ label.name }}"><button type="submit">×</button></form>
                </span>
                {% endfor %}
                <div class="searchable-select tag-select">
                    <input type="text" class="tag-search" placeholder="+ Add" data-target="labels-list">
                    <div class="tag-dropdown" id="labels-list">
                        {% for lbl in all_labels %}
                        {% if lbl not in labels_names %}
                        <form method="post" class="tag-option" data-search="{{ lbl }}">
                            {% csrf_token %}
                            <input type="hidden" name="quick_update" value="add_label">
                            <input type="hidden" name="label" value="{{ lbl }}">
                            <button type="submit">{{ lbl }}</button>
                        </form>
                        {% endif %}
                        {% endfor %}
                        <form method="post" class="tag-option tag-create hidden" data-search="">
                            {% csrf_token %}
                            <input type="hidden" name="quick_update" value="add_label">
                            <input type="hidden" name="label" value="" class="new-tag-value">
                            <button type="submit">+ Create "<span class="new-tag-name"></span>"</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <div class="overview-field overview-field-wide">
            <span class="field-label">People</span>
            <div class="field-value tag-chips">
                {% for person in people %}
                <span class="people-chip" style="background: {{ person.color }}20; border-color: {{ person.color }}; color: {{ person.color }};">
                    {% if person.id %}<a href="{% url 'person_detail' person_id=person.id %}">{{ person.name }}</a>{% else %}{{ person.name }}{% endif %}
                    <form method="post" class="chip-remove">{% csrf_token %}<input type="hidden" name="quick_update" value="remove_person"><input type="hidden" name="person" value="{{ person.name }}"><button type="submit">×</button></form>
                </span>
                {% endfor %}
                <div class="searchable-select tag-select">
                    <input type="text" class="tag-search" placeholder="+ Add" data-target="people-list">
                    <div class="tag-dropdown" id="people-list">
                        {% for p in all_people %}
                        {% if p not in people_names %}
                        <form method="post" class="tag-option" data-search="{{ p }}">
                            {% csrf_token %}
                            <input type="hidden" name="quick_update" value="add_person">
                            <input type="hidden" name="person" value="{{ p }}">
                            <button type="submit">{{ p }}</button>
                        </form>
                        {% endif %}
                        {% endfor %}
                        <form method="post" class="tag-option tag-create hidden" data-search="">
                            {% csrf_token %}
                            <input type="hidden" name="quick_update" value="add_person">
                            <input type="hidden" name="person" value="" class="new-tag-value">
                            <button type="submit">+ Create "<span class="new-tag-name"></span>"</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    {% if content %}
    <div class="overview-row overview-description">
        <div class="overview-field overview-field-full">
            <span class="field-label">Description</span>
            <div class="field-value content">{{ content|markdownify|safe }}</div>
        </div>
    </div>
    {% endif %}
</div>

{% if markdown_total > 0 %}
<div class="section">
    <div class="section-title">Description Progress ({{ markdown_progress }}%)</div>
    <div class="progress">
        <div class="progress-bar" style="width: {{ markdown_progress }}%"></div>
    </div>
</div>
{% endif %}

{% if not edit_mode %}
    <!-- Checklist Section -->
    <details class="section checklist-section"{% if metadata.checklist %} open{% endif %}>
        <summary class="section-title">Checklist{% if metadata.checklist %} ({{ metadata.checklist|length }}){% endif %}</summary>
        {% if metadata.checklist %}
            <div class="item-list">
                {% for item in metadata.checklist %}
                <div class="checklist-item {% if item.status == 'done' %}done{% endif %}">
                    <form method="post" class="form-contents">
                        {% csrf_token %}
                        <input type="hidden" name="checklist_toggle_id" value="{{ item.id }}">
                        <input type="checkbox" onchange="this.form.submit()" {% if item.status == 'done' %}checked{% endif %}>
                    </form>
                    <span class="checklist-title">{{ item.title }}</span>
                    <div class="checklist-actions">
                        <form method="post" class="form-inline">
                            {% csrf_token %}
                            <input type="hidden" name="checklist_delete_id" value="{{ item.id }}">
                            <button type="submit" class="delete">delete</button>
                        </form>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="empty">No checklist items yet.</div>
        {% endif %}

        <form method="post" class="checklist-add">
            {% csrf_token %}
            <input type="text" name="checklist_add_title" placeholder="Add checklist item..." required>
            <button type="submit">Add</button>
        </form>
    </details>

    {% with blocks_count=blocks|length blocked_count=blocked_by|length %}
    <details class="section compact-section"{% if blocks or blocked_by %} open{% endif %}>
        <summary class="section-title">Dependencies{% if blocks or blocked_by %} ({{ blocks_count|add:blocked_count }}){% endif %}</summary>
        <div class="dependencies-row">
            <div class="compact-group">
                <strong class="compact-label">Blocks</strong>
                <div class="searchable-select">
                    <input type="text" class="dep-search" placeholder="Search tasks to add..." data-target="blocks-list">
                    <div class="dep-dropdown" id="blocks-list">
                        {% for t in available_tasks %}
                        <form method="post" class="dep-option" data-search="{{ t.seq_id }} {{ t.title }} {{ t.epic_title }}">
                            {% csrf_token %}
                            <input type="hidden" name="add_block" value="{{ t.id }}">
                            <button type="submit">
                                {% if t.seq_id %}<span class="seq-id">{{ t.seq_id }}</span>{% endif %}
                                {{ t.title }}
                                <span class="dep-option-meta">{{ t.epic_title }} · {{ t.status }}</span>
                            </button>
                        </form>
                        {% endfor %}
                    </div>
                </div>
                {% if blocks %}
                <div class="dependency-list">
                    {% for block in blocks %}
                    <div class="dependency-item">
                        <div class="dep-main">
                            {% if block.seq_id %}<span class="seq-id">{{ block.seq_id }}</span>{% endif %}
                            {% if block.type == 'task' %}
                            <a href="{% url 'task_detail' project=project epic=block.epic_id task=block.id %}">{{ block.title }}</a>
                            {% else %}
                            <a href="{% url 'subtask_detail' project=project epic=block.epic_id task=block.task_id subtask=block.id %}">{{ block.title }}</a>
                            {% endif %}
                            <span class="badge badge-status status-{{ block.status }}">{{ block.status }}</span>
                        </div>
                        <div class="dep-meta">{{ block.epic_title }}</div>
                        <form method="post" class="dep-remove">{% csrf_token %}<input type="hidden" name="remove_block" value="{{ block.id }}"><button type="submit" class="delete-inline">×</button></form>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            <div class="compact-group">
                <strong class="compact-label">Blocked by</strong>
                <div class="searchable-select">
                    <input type="text" class="dep-search" placeholder="Search tasks to add..." data-target="blocked-by-list">
                    <div class="dep-dropdown" id="blocked-by-list">
                        {% for t in available_tasks %}
                        <form method="post" class="dep-option" data-search="{{ t.seq_id }} {{ t.title }} {{ t.epic_title }}">
                            {% csrf_token %}
                            <input type="hidden" name="add_blocked_by" value="{{ t.id }}">
                            <button type="submit">
                                {% if t.seq_id %}<span class="seq-id">{{ t.seq_id }}</span>{% endif %}
                                {{ t.title }}
                                <span class="dep-option-meta">{{ t.epic_title }} · {{ t.status }}</span>
                            </button>
                        </form>
                        {% endfor %}
                    </div>
                </div>
                {% if blocked_by %}
                <div class="dependency-list">
                    {% for blocker in blocked_by %}
                    <div class="dependency-item">
                        <div class="dep-main">
                            {% if blocker.seq_id %}<span class="seq-id">{{ blocker.seq_id }}</span>{% endif %}
                            {% if blocker.type == 'task' %}
                            <a href="{% url 'task_detail' project=project epic=blocker.epic_id task=blocker.id %}">{{ blocker.title }}</a>
                            {% else %}
                            <a href="{% url 'subtask_detail' project=project epic=blocker.epic_id task=blocker.task_id subtask=blocker.id %}">{{ blocker.title }}</a>
                            {% endif %}
                            <span class="badge badge-status status-{{ blocker.status }}">{{ blocker.status }}</span>
                        </div>
                        <div class="dep-meta">{{ blocker.epic_title }}</div>
                        <form method="post" class="dep-remove">{% csrf_token %}<input type="hidden" name="remove_blocked_by" value="{{ blocker.id }}"><button type="submit" class="delete-inline">×</button></form>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>
    </details>
    {% endwith %}

    <!-- Notes Section -->
    <details class="section compact-section"{% if associated_notes %} open{% endif %}>
        <summary class="section-title">Notes{% if associated_notes %} ({{ associated_notes|length }}){% endif %}</summary>
        <div class="notes-section">
            <div class="searchable-select note-select">
                <input type="text" class="note-search" placeholder="Search notes to link..." data-target="notes-list">
                <div class="note-dropdown" id="notes-list">
                    {% for note in available_notes %}
                    <form method="post" class="note-option" data-search="{{ note.title }}">
                        {% csrf_token %}
                        <input type="hidden" name="quick_update" value="add_note">
                        <input type="hidden" name="note_id" value="{{ note.id }}">
                        <button type="submit">{{ note.title }}</button>
                    </form>
                    {% empty %}
                    <div class="empty-option">No notes available</div>
                    {% endfor %}
                </div>
            </div>
            {% if associated_notes %}
            <div class="notes-list">
                {% for note in associated_notes %}
                <div class="note-item">
                    <div class="note-info">
                        <a href="{% url 'note_detail' note_id=note.id %}">{{ note.title }}</a>
                        {% if note.preview %}<span class="note-preview">{{ note.preview }}...</span>{% endif %}
                    </div>
                    <form method="post" class="note-remove">
                        {% csrf_token %}
                        <input type="hidden" name="quick_update" value="remove_note">
                        <input type="hidden" name="note_id" value="{{ note.id }}">
                        <button type="submit" class="delete-inline">×</button>
                    </form>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty">No notes linked yet.</div>
            {% endif %}
        </div>
    </details>

    <div class="section">
        <div class="section-title">Activity</div>
        <div class="activity-filters">
            <label>
                <input type="checkbox" id="filter-system" checked> System messages
            </label>
            <label>
                <input type="checkbox" id="filter-user" checked> User messages
            </label>
        </div>
        
        <form method="post" class="update-form" id="update-form">
            {% csrf_token %}
            <textarea name="update_content" id="update_content" placeholder="Add update..." required></textarea>
            <button type="submit" id="update-submit-btn" class="update-submit-btn">Post Update</button>
        </form>
        
        {% if updates %}
        <div id="activity-list">
        {% for update in updates %}
        <div class="update update-{{ update.type|default:'user' }}" data-update-type="{{ update.type|default:'user' }}">
            <div class="update-meta">
                <span class="update-timestamp">{{ update.timestamp|date:"Y-m-d H:i" }}</span>
                {% if update.type == 'system' %}
                <span class="update-type-badge">system</span>
                {% else %}
                <span class="update-type-badge">user</span>
                {% endif %}
            </div>
            <div class="update-content content">{{ update.content|markdownify|safe }}</div>
        </div>
        {% endfor %}
        </div>
        {% else %}
        <div class="empty">No activity yet.</div>
        {% endif %}
    </div>

{% else %}
    <div class="section">
        <form method="post">
            {% csrf_token %}

            <div class="form-group">
                <label for="title">Title</label>
                <input type="text" name="title" id="title" value="{{ metadata.title }}" required>
            </div>

            <div class="form-group">
                <label for="status">Status</label>
                <select name="status" id="status">
                    <option value="todo" {% if metadata.status == 'todo' %}selected{% endif %}>todo</option>
                    <option value="in_progress" {% if metadata.status == 'in_progress' %}selected{% endif %}>in progress</option>
                    <option value="done" {% if metadata.status == 'done' %}selected{% endif %}>done</option>
                </select>
            </div>

            <div class="form-group">
                <label for="priority">Priority</label>
                <select name="priority" id="priority">
                    <option value="">None</option>
                    <option value="1" {% if metadata.priority == '1' %}selected{% endif %}>1 (Highest)</option>
                    <option value="2" {% if metadata.priority == '2' %}selected{% endif %}>2</option>
                    <option value="3" {% if metadata.priority == '3' %}selected{% endif %}>3</option>
                    <option value="4" {% if metadata.priority == '4' %}selected{% endif %}>4</option>
                    <option value="5" {% if metadata.priority == '5' %}selected{% endif %}>5 (Lowest)</option>
                </select>
            </div>

            <div class="form-group">
                <label for="due_date">Due Date/Time</label>
                <input type="datetime-local" name="due_date" id="due_date" value="{% if metadata.due_date and metadata.due_date|length == 10 %}{{ metadata.due_date }}T00:00{% else %}{{ metadata.due_date }}{% endif %}">
            </div>

            <div class="form-group">
                <label for="labels">Labels (comma-separated)</label>
                <input type="text" name="labels" id="labels" value="{{ metadata.labels|join:', ' }}">
            </div>

            <div class="form-group">
                <label for="content">Description (markdown)</label>
                <textarea name="content" id="content">{{ content }}</textarea>
            </div>

            <div class="form-actions">
                <button type="submit">Save Changes</button>
                <a href="{% url 'subtask_detail' project=project epic=epic task=task subtask=subtask %}" class="button button-secondary">Cancel</a>
            </div>
        </form>
    </div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
    // Auto-submit schedule forms
    var quickStart = document.getElementById('quick_schedule_start');
    if (quickStart) {
        quickStart.addEventListener('change', function() {
            var form = document.getElementById('schedule-start-form');
            if (form) form.submit();
        });
    }
    
    var quickEnd = document.getElementById('quick_schedule_end');
    if (quickEnd) {
        quickEnd.addEventListener('change', function() {
            var form = document.getElementById('schedule-end-form');
            if (form) form.submit();
        });
    }

    var quickDue = document.getElementById('quick_due_date');
    if (quickDue) {
        quickDue.addEventListener('change', function() {
            var form = document.getElementById('due-date-form');
            if (form) form.submit();
        });
    }
    
    // Initialize EasyMDE for update editor
    var updateEditor = null;
    var updateTextarea = document.getElementById('update_content');
    var updateForm = document.getElementById('update-form');
    
    if (updateTextarea && updateForm) {
        updateEditor = new EasyMDE({
            element: updateTextarea,
            spellChecker: false,
            toolbar: ['bold', 'italic', 'heading', '|', 'quote', 'unordered-list', 'ordered-list', '|', 'link', 'image', 'code', 'table', '|', 'preview', 'side-by-side', 'fullscreen', '|', 'guide'],
            minHeight: '150px',
            placeholder: 'Add update... (Markdown supported)',
            status: false,
            autosave: {
                enabled: false
            }
        });

        // Keep textarea value in sync for required validation
        updateEditor.codemirror.on('change', function() {
            updateTextarea.value = updateEditor.value();
        });
        
        // Handle clipboard image paste (Ctrl+V)
        updateEditor.codemirror.on('paste', function(cm, e) {
            var clipboardData = e.clipboardData || window.clipboardData;
            if (!clipboardData) return;
            
            var items = clipboardData.items;
            if (!items) return;
            
            // Check if clipboard contains image
            for (var i = 0; i < items.length; i++) {
                if (items[i].type.indexOf('image') !== -1) {
                    e.preventDefault();
                    var file = items[i].getAsFile();
                    
                    // Show loading indicator
                    var cursor = cm.getCursor();
                    var loadingText = '![Uploading image...]()';
                    cm.replaceRange(loadingText, cursor);
                    
                    // Upload image
                    var formData = new FormData();
                    formData.append('image', file);
                    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
                    
                    fetch('{% url "upload_image" %}', {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    })
                    .then(function(response) {
                        return response.json();
                    })
                    .then(function(data) {
                        if (data.success) {
                            // Replace loading text with markdown image
                            var markdownImage = '![' + file.name + '](' + data.url + ')';
                            var content = cm.getValue();
                            content = content.replace(loadingText, markdownImage);
                            cm.setValue(content);
                            updateTextarea.value = content;
                        } else {
                            // Replace loading text with error message
                            var errorText = '![Image upload failed: ' + (data.error || 'Unknown error') + ']()';
                            var content = cm.getValue();
                            content = content.replace(loadingText, errorText);
                            cm.setValue(content);
                            updateTextarea.value = content;
                        }
                    })
                    .catch(function(err) {
                        // Replace loading text with error message
                        var errorText = '![Image upload failed: Network error]()';
                        var content = cm.getValue();
                        content = content.replace(loadingText, errorText);
                        cm.setValue(content);
                        updateTextarea.value = content;
                    });
                    
                    return;
                }
            }
        });
        
        // Ensure textarea value is synced before form submission
        updateForm.addEventListener('submit', function(e) {
            if (updateEditor) {
                // Sync EasyMDE value back to textarea
                var editorValue = updateEditor.value();
                updateTextarea.value = editorValue;
                
                // Make sure textarea is visible and has value
                if (!updateTextarea.value || updateTextarea.value.trim() === '') {
                    e.preventDefault();
                    alert('Please enter an update before posting.');
                    return false;
                }
            }
        });
        
        // Also sync on button click as backup
        var submitBtn = document.getElementById('update-submit-btn');
        if (submitBtn) {
            submitBtn.addEventListener('click', function(e) {
                if (updateEditor) {
                    updateTextarea.value = updateEditor.value();
                }
            });
        }
    }

    // Searchable dependency dropdowns
    document.querySelectorAll('.dep-search').forEach(function(input) {
        var targetId = input.getAttribute('data-target');
        var dropdown = document.getElementById(targetId);
        
        input.addEventListener('input', function() {
            var query = input.value.toLowerCase();
            dropdown.querySelectorAll('.dep-option').forEach(function(opt) {
                var searchText = opt.getAttribute('data-search').toLowerCase();
                if (searchText.includes(query)) {
                    opt.classList.remove('hidden');
                } else {
                    opt.classList.add('hidden');
                }
            });
        });
        
        input.addEventListener('focus', function() {
            dropdown.style.display = 'block';
        });
        
        input.addEventListener('blur', function() {
            // Delay hide to allow click on dropdown
            setTimeout(function() {
                dropdown.style.display = 'none';
            }, 200);
        });
    });

    // Searchable tag dropdowns (labels and people)
    document.querySelectorAll('.tag-search').forEach(function(input) {
        var targetId = input.getAttribute('data-target');
        var dropdown = document.getElementById(targetId);
        var createOption = dropdown ? dropdown.querySelector('.tag-create') : null;
        
        if (!dropdown) return;
        
        input.addEventListener('input', function() {
            var query = input.value.toLowerCase().trim();
            var hasExactMatch = false;
            var visibleOptions = 0;
            
            // Show/hide existing options
            dropdown.querySelectorAll('.tag-option:not(.tag-create)').forEach(function(opt) {
                var searchText = opt.getAttribute('data-search') || '';
                searchText = searchText.toLowerCase();
                if (query && searchText.includes(query)) {
                    opt.classList.remove('hidden');
                    visibleOptions++;
                    if (searchText === query) hasExactMatch = true;
                } else if (query) {
                    opt.classList.add('hidden');
                } else {
                    // Show all when query is empty
                    opt.classList.remove('hidden');
                    visibleOptions++;
                }
            });
            
            // Show/hide create option
            if (createOption) {
                if (query && !hasExactMatch) {
                    createOption.classList.remove('hidden');
                    var nameSpan = createOption.querySelector('.new-tag-name');
                    var valueInput = createOption.querySelector('.new-tag-value');
                    if (nameSpan) nameSpan.textContent = input.value;
                    if (valueInput) valueInput.value = input.value;
                } else if (query && visibleOptions === 0) {
                    // Show create option if no matches found
                    createOption.classList.remove('hidden');
                    var nameSpan = createOption.querySelector('.new-tag-name');
                    var valueInput = createOption.querySelector('.new-tag-value');
                    if (nameSpan) nameSpan.textContent = input.value;
                    if (valueInput) valueInput.value = input.value;
                } else {
                    createOption.classList.add('hidden');
                }
            }
        });
        
        input.addEventListener('focus', function() {
            dropdown.style.display = 'block';
            // Show create option if there's text and no exact match
            if (createOption && input.value.trim()) {
                var query = input.value.toLowerCase().trim();
                var hasExactMatch = false;
                dropdown.querySelectorAll('.tag-option:not(.tag-create)').forEach(function(opt) {
                    var searchText = (opt.getAttribute('data-search') || '').toLowerCase();
                    if (searchText === query) hasExactMatch = true;
                });
                if (!hasExactMatch) {
                    createOption.classList.remove('hidden');
                    var nameSpan = createOption.querySelector('.new-tag-name');
                    var valueInput = createOption.querySelector('.new-tag-value');
                    if (nameSpan) nameSpan.textContent = input.value;
                    if (valueInput) valueInput.value = input.value;
                }
            }
        });
        
        input.addEventListener('blur', function() {
            setTimeout(function() {
                dropdown.style.display = 'none';
            }, 200);
        });
    });

    // Searchable note dropdown
    document.querySelectorAll('.note-search').forEach(function(input) {
        var targetId = input.getAttribute('data-target');
        var dropdown = document.getElementById(targetId);
        
        input.addEventListener('input', function() {
            var query = input.value.toLowerCase();
            dropdown.querySelectorAll('.note-option').forEach(function(opt) {
                var searchText = opt.getAttribute('data-search').toLowerCase();
                if (searchText.includes(query)) {
                    opt.classList.remove('hidden');
                } else {
                    opt.classList.add('hidden');
                }
            });
        });
        
        input.addEventListener('focus', function() {
            dropdown.style.display = 'block';
        });
        
        input.addEventListener('blur', function() {
            setTimeout(function() {
                dropdown.style.display = 'none';
            }, 200);
        });
    });

    // Activity filtering
    var filterSystem = document.getElementById('filter-system');
    var filterUser = document.getElementById('filter-user');
    var activityList = document.getElementById('activity-list');
    
    function updateActivityFilter() {
        if (!activityList) return;
        var showSystem = filterSystem.checked;
        var showUser = filterUser.checked;
        
        activityList.querySelectorAll('.update').forEach(function(update) {
            var updateType = update.getAttribute('data-update-type');
            if ((updateType === 'system' && showSystem) || (updateType === 'user' && showUser)) {
                update.style.display = '';
            } else {
                update.style.display = 'none';
            }
        });
    }
    
    if (filterSystem) filterSystem.addEventListener('change', updateActivityFilter);
    if (filterUser) filterUser.addEventListener('change', updateActivityFilter);
</script>
{% endblock %}
