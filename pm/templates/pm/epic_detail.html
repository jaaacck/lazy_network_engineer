{% extends "pm/base.html" %}
{% load markdown_extras %}

{% block content %}
<div class="breadcrumb">
    <a href="{% url 'project_list' %}">projects</a> &gt;
    <a href="{% url 'project_detail' project=project %}">{{ project_title }}</a> &gt;
    {{ metadata.title }}
</div>

<div class="page-title">
    <span>{% if metadata.seq_id %}<span class="seq-id">{{ metadata.seq_id }}</span>{% endif %}{{ metadata.title }}</span>
    {% if not is_inbox_epic %}
    <div class="mode-toggle">
        <a href="{% url 'kanban_epic' project=project epic=epic %}">kanban</a>
        {% if not metadata.archived %}
        <form method="post">
            {% csrf_token %}
            <input type="hidden" name="archive" value="1">
            <button type="submit">Archive</button>
        </form>
        {% else %}
        <form method="post">
            {% csrf_token %}
            <input type="hidden" name="unarchive" value="1">
            <button type="submit">Unarchive</button>
        </form>
        {% endif %}
        <button class="move-epic-button" id="move-epic-button">Move</button>
    </div>
    {% endif %}
</div>

{% if not is_inbox_epic %}
<!-- Epic Overview -->
<div class="task-overview">
    <div class="overview-row overview-main">
        <div class="overview-field">
            <span class="field-label">Status</span>
            <form method="post" class="field-value status-reason-form" data-auto-submit="true">
                {% csrf_token %}
                <input type="hidden" name="quick_update" value="status">
                <select name="status" class="badge badge-status status-{{ metadata.status }} status-reason-select">
                    {% for status in all_statuses %}
                    <option value="{{ status.name }}" data-requires-reason="{% if status.pending_reason %}1{% else %}0{% endif %}" {% if metadata.status == status.name %}selected{% endif %}>{{ status.display_name }}</option>
                    {% endfor %}
                </select>
                <input type="text" name="pending_reason" class="pending-reason-input" placeholder="Reason..." value="{{ metadata.pending_reason|default:'' }}" style="display: none; margin-left: 6px; padding: 2px 6px; font-size: 12px;">
                <button type="submit" class="pending-reason-save" style="display: none; margin-left: 6px;">Save</button>
            </form>
        </div>
        <div class="overview-field">
            <span class="field-label">Priority</span>
            <form method="post" class="field-value">
                {% csrf_token %}
                <input type="hidden" name="quick_update" value="priority">
                <select name="priority" class="badge badge-priority priority-{{ metadata.priority|default:'none' }}" onchange="this.form.submit()">
                    <option value="">None</option>
                    <option value="1" {% if metadata.priority == 1 %}selected{% endif %}>P1</option>
                    <option value="2" {% if metadata.priority == 2 %}selected{% endif %}>P2</option>
                    <option value="3" {% if metadata.priority == 3 %}selected{% endif %}>P3</option>
                    <option value="4" {% if metadata.priority == 4 %}selected{% endif %}>P4</option>
                    <option value="5" {% if metadata.priority == 5 %}selected{% endif %}>P5</option>
                </select>
            </form>
        </div>
        {% if total_tasks > 0 %}
        <div class="overview-field overview-progress">
            <span class="field-label">Progress</span>
            <div class="field-value">
                <div class="progress-inline">
                    <div class="progress-bar" style="width: {{ progress_percentage }}%"></div>
                </div>
                <span class="progress-text">{{ progress_percentage|floatformat:0 }}%</span>
            </div>
        </div>
        {% endif %}
        <div class="overview-field overview-created">
            <span class="field-label">Created</span>
            <span class="field-value">{{ metadata.created }}</span>
        </div>
    </div>
    
    <div class="overview-row overview-dates">
        <div class="overview-field">
            <span class="field-label">Due</span>
            <form method="post" class="field-value" id="due-date-form">
                {% csrf_token %}
                <input type="hidden" name="quick_update" value="due_date">
                <input type="datetime-local" name="due_date" id="quick_due_date" value="{% if metadata.due_date and metadata.due_date|length == 10 %}{{ metadata.due_date }}T00:00{% else %}{{ metadata.due_date }}{% endif %}">
            </form>
        </div>
    </div>
    
    <div class="overview-row overview-tags">
        <div class="overview-field overview-field-wide">
            <span class="field-label">Labels</span>
            <div class="field-value tag-chips">
                {% for label in labels %}
                <span class="label-chip" style="background: {{ label.color }}20; border-color: {{ label.color }}; color: {{ label.color }};">
                    <a href="{% url 'search' %}?q={{ label.name|urlencode }}">{{ label.name }}</a>
                    <form method="post" class="chip-remove">{% csrf_token %}<input type="hidden" name="quick_update" value="remove_label"><input type="hidden" name="label" value="{{ label.name }}"><button type="submit">×</button></form>
                </span>
                {% endfor %}
                <div class="searchable-select tag-select">
                    <input type="text" class="tag-search" placeholder="+ Add" data-target="labels-list">
                    <div class="tag-dropdown" id="labels-list">
                        {% for lbl in all_labels %}
                        {% if lbl not in labels_names %}
                        <form method="post" class="tag-option" data-search="{{ lbl }}">
                            {% csrf_token %}
                            <input type="hidden" name="quick_update" value="add_label">
                            <input type="hidden" name="label" value="{{ lbl }}">
                            <button type="submit">{{ lbl }}</button>
                        </form>
                        {% endif %}
                        {% endfor %}
                        <form method="post" class="tag-option tag-create hidden" data-search="">
                            {% csrf_token %}
                            <input type="hidden" name="quick_update" value="add_label">
                            <input type="hidden" name="label" value="" class="new-tag-value">
                            <button type="submit">+ Create "<span class="new-tag-name"></span>"</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <div class="overview-field overview-field-wide">
            <span class="field-label">People</span>
            <div class="field-value tag-chips">
                {% for person in people %}
                <span class="people-chip" style="background: {{ person.color }}20; border-color: {{ person.color }}; color: {{ person.color }};">
                    {% if person.id %}<a href="{% url 'person_detail' person_id=person.id %}">{{ person.name }}</a>{% else %}{{ person.name }}{% endif %}
                    <form method="post" class="chip-remove">{% csrf_token %}<input type="hidden" name="quick_update" value="remove_person"><input type="hidden" name="person" value="{{ person.name }}"><button type="submit">×</button></form>
                </span>
                {% endfor %}
                <div class="searchable-select tag-select">
                    <input type="text" class="tag-search" placeholder="+ Add" data-target="people-list">
                    <div class="tag-dropdown" id="people-list">
                        {% for p in all_people %}
                        {% if p not in people_names %}
                        <form method="post" class="tag-option" data-search="{{ p }}">
                            {% csrf_token %}
                            <input type="hidden" name="quick_update" value="add_person">
                            <input type="hidden" name="person" value="{{ p }}">
                            <button type="submit">{{ p }}</button>
                        </form>
                        {% endif %}
                        {% endfor %}
                        <form method="post" class="tag-option tag-create hidden" data-search="">
                            {% csrf_token %}
                            <input type="hidden" name="quick_update" value="add_person">
                            <input type="hidden" name="person" value="" class="new-tag-value">
                            <button type="submit">+ Create "<span class="new-tag-name"></span>"</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="overview-row overview-description" id="description-container" style="position: relative;{% if not content %} display: none;{% endif %}">
        <button class="description-edit-btn" id="description-edit-btn" style="position: absolute; top: 8px; right: 8px;">edit</button>
        <div class="overview-field overview-field-full">
            <span class="field-label">Description</span>
            <div class="field-value content" id="description-display">
                {% if content %}{{ content|markdownify|safe }}{% else %}<span style="color: #828282;">No description</span>{% endif %}
            </div>
            <div id="description-editor-container" style="display: none; margin-top: 10px;">
                <textarea id="description-editor">{% if content %}{{ content }}{% endif %}</textarea>
                <div class="description-actions" style="margin-top: 10px;">
                    <button type="button" id="description-save-btn">Save</button>
                    <button type="button" id="description-cancel-btn">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    {% if not content %}
    <div class="overview-row" id="description-add-row">
        <div class="overview-field overview-field-wide">
            <button class="description-add-btn" id="description-add-btn" style="padding: 10px 16px; background: transparent; border: 2px dashed #d0d0d0; border-radius: 4px; cursor: pointer; font-size: 14px; width: 100%; text-align: left; color: #666;">+ Add description</button>
        </div>
    </div>
    {% endif %}
</div>
{% endif %}

    {% if not is_inbox_epic %}
    <!-- Checklist Section -->
    <details class="section checklist-section">
        <summary class="section-title">Checklist</summary>
        {% if metadata.checklist %}
            <div class="item-list">
                {% for item in metadata.checklist %}
                <div class="checklist-item {% if item.status == 'done' %}done{% endif %}">
                    <form method="post" class="form-contents">
                        {% csrf_token %}
                        <input type="hidden" name="checklist_toggle_id" value="{{ item.id }}">
                        <input type="checkbox" onchange="this.form.submit()" {% if item.status == 'done' %}checked{% endif %}>
                    </form>
                    <span class="checklist-title">{{ item.title }}</span>
                    <div class="checklist-actions">
                        <form method="post" class="form-inline">
                            {% csrf_token %}
                            <input type="hidden" name="checklist_delete_id" value="{{ item.id }}">
                            <button type="submit" class="delete">delete</button>
                        </form>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="empty">No checklist items yet.</div>
        {% endif %}

        <form method="post" class="checklist-add">
            {% csrf_token %}
            <input type="text" name="checklist_add_title" placeholder="Add checklist item..." required>
            <button type="submit">Add</button>
        </form>
    </details>
    {% endif %}

    <!-- Notes Section -->
    <details class="section compact-section"{% if associated_notes %} open{% endif %}>
        <summary class="section-title">Notes{% if associated_notes %} ({{ associated_notes|length }}){% endif %}</summary>
        <div class="notes-section">
            <div class="searchable-select note-select">
                <input type="text" class="note-search" placeholder="Search notes to link..." data-target="notes-list">
                <div class="note-dropdown" id="notes-list">
                    {% for note in available_notes %}
                    <form method="post" class="note-option" data-search="{{ note.title }}">
                        {% csrf_token %}
                        <input type="hidden" name="quick_update" value="add_note">
                        <input type="hidden" name="note_id" value="{{ note.id }}">
                        <button type="submit">{{ note.title }}</button>
                    </form>
                    {% empty %}
                    <div class="empty-option">No notes available</div>
                    {% endfor %}
                </div>
            </div>
            {% if associated_notes %}
            <div class="notes-list">
                {% for note in associated_notes %}
                <div class="note-item">
                    <div class="note-info">
                        <a href="{% url 'note_detail' note_id=note.id %}">{{ note.title }}</a>
                        {% if note.preview %}<span class="note-preview">{{ note.preview }}...</span>{% endif %}
                    </div>
                    <form method="post" class="note-remove">
                        {% csrf_token %}
                        <input type="hidden" name="quick_update" value="remove_note">
                        <input type="hidden" name="note_id" value="{{ note.id }}">
                        <button type="submit" class="delete-inline">×</button>
                    </form>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty">No notes linked yet.</div>
            {% endif %}
        </div>
    </details>

    <div class="section">
        <div class="section-title">Tasks{% if not is_inbox_epic %} (<span id="tasks-count">{{ completed_tasks }}/{{ total_tasks }}</span>){% endif %}</div>
        <form method="post" action="{% url 'new_task' project=project epic=epic %}" class="quick-setting-form ajax-create-form status-reason-form" id="new-task-form">
            {% csrf_token %}
            <label for="quick_task_title">Task</label>
            <input type="text" name="title" id="quick_task_title" placeholder="Task title" required>
            {% if not is_inbox_epic %}
            <select name="priority">
                <option value="">Priority</option>
                <option value="1">P1</option>
                <option value="2">P2</option>
                <option value="3">P3</option>
                <option value="4">P4</option>
                <option value="5">P5</option>
            </select>
            <select name="status" class="status-reason-select">
                {% for status in all_statuses %}
                <option value="{{ status.name }}" data-requires-reason="{% if status.pending_reason %}1{% else %}0{% endif %}">{{ status.display_name }}</option>
                {% endfor %}
            </select>
            <input type="text" name="pending_reason" class="pending-reason-input" placeholder="Reason..." style="display: none; padding: 4px 6px; font-size: 12px;">
            {% endif %}
            <button type="submit">Create</button>
        </form>

        {% if not is_inbox_epic %}
        <div class="progress" id="tasks-progress"{% if total_tasks == 0 %} style="display: none;"{% endif %}>
            <div class="progress-bar" id="tasks-progress-bar" style="width: {{ progress_percentage }}%"></div>
        </div>

        <!-- Bulk Action Bar -->
        <div class="bulk-action-bar" id="bulk-action-bar" style="display: none;">
            <span class="bulk-count"><span id="selected-count">0</span> selected</span>
            <select id="bulk-status">
                <option value="">Set Status...</option>
                {% for status in all_statuses %}
                <option value="{{ status.name }}">{{ status.display_name }}</option>
                {% endfor %}
            </select>
            <input type="text" id="bulk-pending-reason" placeholder="Reason..." style="display: none; padding: 4px 6px; font-size: 12px;">
            <select id="bulk-priority">
                <option value="">Set Priority...</option>
                <option value="">None</option>
                <option value="1">P1</option>
                <option value="2">P2</option>
                <option value="3">P3</option>
                <option value="4">P4</option>
                <option value="5">P5</option>
            </select>
            <button type="button" id="bulk-apply" class="btn-primary">Apply Changes</button>
            <button type="button" id="bulk-delete" class="btn-danger">Delete</button>
            <button type="button" id="bulk-cancel" class="btn-secondary">Cancel</button>
        </div>
        {% endif %}

        {% if is_inbox_epic %}
        <!-- Simplified task list for inbox - just titles -->
        <div class="item-list" id="tasks-list"{% if not tasks %} style="display: none;"{% endif %}>
            {% for task in tasks %}
            <div class="item">
                <div class="item-title">
                    <a href="{% url 'task_detail' project=project epic=epic task=task.id %}">{{ task.title }}</a>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <table id="tasks-table"{% if not tasks %} style="display: none;"{% endif %} class="sortable-table">
            <thead>
            <tr>
                <th class="col-checkbox"><input type="checkbox" id="select-all-tasks" title="Select all"></th>
                <th class="sortable" data-sort="title">Task <span class="sort-indicator">↕</span></th>
                <th class="sortable" data-sort="status">Status <span class="sort-indicator">↕</span></th>
                <th class="sortable" data-sort="priority">Priority <span class="sort-indicator">↕</span></th>
                <th class="sortable" data-sort="created">Created <span class="sort-indicator">↕</span></th>
                <th class="sortable" data-sort="due_date">Due Date <span class="sort-indicator">↕</span></th>
            </tr>
            </thead>
            <tbody id="tasks-tbody">
            {% for task in tasks %}
            <tr class="draggable-row task-row" data-task-id="{{ task.id }}" 
                data-title="{{ task.title|lower }}" 
                data-status="{{ task.status }}" 
                data-priority="{{ task.priority|default:'999' }}" 
                data-created="{{ task.created|default:'9999-99-99' }}" 
                data-due-date="{{ task.due_date|default:'9999-99-99' }}">
                <td class="col-checkbox"><input type="checkbox" class="task-checkbox" value="{{ task.id }}"></td>
                <td>{% if task.seq_id %}<span class="seq-id">{{ task.seq_id }}</span>{% endif %}<a href="{% url 'task_detail' project=project epic=epic task=task.id %}">{{ task.title }}</a></td>
                <td><span class="badge badge-status status-{{ task.status }}">{{ task.status_display|default:task.status }}</span></td>
                <td>{% if task.priority %}<span class="badge badge-priority priority-{{ task.priority }}">P{{ task.priority }}</span>{% else %}<span class="text-muted">—</span>{% endif %}</td>
                <td>{% if task.created %}{{ task.created }}{% else %}<span class="text-muted">—</span>{% endif %}</td>
                <td>{% if task.due_date %}{{ task.due_date }}{% else %}<span class="text-muted">—</span>{% endif %}</td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
        {% endif %}
        <div id="tasks-empty" class="empty"{% if tasks %} style="display: none;"{% endif %}>No tasks yet.</div>
    </div>
{% endblock %}

{% block scripts %}
<script>
    // AJAX task creation
    var taskForm = document.getElementById('new-task-form');
    var totalTasks = {{ total_tasks }};
    var completedTasks = {{ completed_tasks }};
    
    if (taskForm) {
        taskForm.addEventListener('submit', function(e) {
            e.preventDefault();
            var formData = new FormData(taskForm);
            
            fetch(taskForm.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(function(response) { return response.json(); })
            .then(function(data) {
                if (data.success) {
                    // Show table if hidden
                    var table = document.getElementById('tasks-table');
                    var tbody = document.getElementById('tasks-tbody');
                    var empty = document.getElementById('tasks-empty');
                    var progress = document.getElementById('tasks-progress');
                    
                    table.style.display = '';
                    empty.style.display = 'none';
                    progress.style.display = '';
                    
                    // Update task count
                    totalTasks++;
                    if (data.status === 'done') completedTasks++;
                    document.getElementById('tasks-count').textContent = completedTasks + '/' + totalTasks;
                    
                    // Update progress bar
                    var pct = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
                    document.getElementById('tasks-progress-bar').style.width = pct + '%';
                    
                    // Create new row
                    var tr = document.createElement('tr');
                    tr.className = 'draggable-row task-row';
                    tr.setAttribute('data-task-id', data.id);
                    tr.setAttribute('data-status', data.status);
                    tr.setAttribute('data-priority', data.priority || '999');
                    tr.setAttribute('data-title', data.title.toLowerCase());
                    tr.setAttribute('data-created', data.created || '9999-99-99');
                    tr.setAttribute('data-due-date', data.due_date || '9999-99-99');
                    var seqIdHtml = data.seq_id ? '<span class="seq-id">' + data.seq_id + '</span>' : '';
                    var priorityHtml = data.priority ? '<span class="badge badge-priority priority-' + data.priority + '">P' + data.priority + '</span>' : '<span class="text-muted">—</span>';
                    var createdHtml = data.created || '<span class="text-muted">—</span>';
                    var dueDateHtml = data.due_date || '<span class="text-muted">—</span>';
                    tr.innerHTML = '<td class="col-checkbox"><input type="checkbox" class="task-checkbox" value="' + data.id + '"></td>' +
                        '<td><span class="badge badge-status status-' + data.status + '">' + (data.status_display || data.status.replace('_', ' ')) + '</span></td>' +
                        '<td>' + priorityHtml + '</td>' +
                        '<td>' + seqIdHtml + '<a href="' + data.url + '">' + escapeHtml(data.title) + '</a></td>' +
                        '<td>' + createdHtml + '</td>' +
                        '<td>' + dueDateHtml + '</td>';
                    tbody.appendChild(tr);
                    
                    // Add checkbox handler to new row
                    tr.querySelector('.task-checkbox').addEventListener('change', updateBulkBar);
                    
                    // Reset form
                    taskForm.reset();
                    taskForm.querySelector('input[name="title"]').focus();
                }
            })
            .catch(function(err) {
                console.error('Error creating task:', err);
            });
        });
    }
    
    function escapeHtml(text) {
        var div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Bulk selection and actions
    var bulkBar = document.getElementById('bulk-action-bar');
    var selectAll = document.getElementById('select-all-tasks');
    var selectedCount = document.getElementById('selected-count');
    
    function getSelectedIds() {
        return Array.from(document.querySelectorAll('.task-checkbox:checked')).map(function(cb) {
            return cb.value;
        });
    }
    
    function updateBulkBar() {
        var selected = getSelectedIds();
        selectedCount.textContent = selected.length;
        bulkBar.style.display = selected.length > 0 ? 'flex' : 'none';
        
        // Update select all checkbox state
        var allCheckboxes = document.querySelectorAll('.task-checkbox');
        selectAll.checked = allCheckboxes.length > 0 && selected.length === allCheckboxes.length;
        selectAll.indeterminate = selected.length > 0 && selected.length < allCheckboxes.length;
    }
    
    // Select all checkbox
    if (selectAll) {
        selectAll.addEventListener('change', function() {
            document.querySelectorAll('.task-checkbox').forEach(function(cb) {
                cb.checked = selectAll.checked;
            });
            updateBulkBar();
        });
    }
    
    // Individual checkboxes
    document.querySelectorAll('.task-checkbox').forEach(function(cb) {
        cb.addEventListener('change', updateBulkBar);
    });
    
    // Bulk apply changes - batch all selected actions into one request
    document.getElementById('bulk-apply').addEventListener('click', function() {
        var ids = getSelectedIds();
        if (ids.length === 0) return;
        
        var actions = [];
        var status = document.getElementById('bulk-status').value;
        var priority = document.getElementById('bulk-priority').value;
        var pendingReason = document.getElementById('bulk-pending-reason').value.trim();
        
        if (status) {
            if ((status === 'on_hold' || status === 'blocked') && !pendingReason) {
                alert('Please provide a reason for On Hold/Blocked');
                return;
            }
            actions.push({type: 'status', value: status, pending_reason: pendingReason});
        }
        if (priority !== '') {
            actions.push({type: 'priority', value: priority});
        }
        
        if (actions.length === 0) {
            alert('Please select at least one action to apply.');
            return;
        }
        
        var formData = new FormData();
        formData.append('type', 'task');
        formData.append('project_id', '{{ project }}');
        formData.append('epic_id', '{{ epic }}');
        formData.append('ids', ids.join(','));
        formData.append('actions', JSON.stringify(actions));
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
        
        fetch('{% url "bulk_update_items" %}', { method: 'POST', body: formData })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(function(err) {
                console.error('Bulk update error:', err);
                alert('Failed to apply changes. Please try again.');
            });
    });
    
    // Toggle pending reason input based on status
    document.getElementById('bulk-status').addEventListener('change', function() {
        var needsReason = this.value === 'on_hold' || this.value === 'blocked';
        var reasonInput = document.getElementById('bulk-pending-reason');
        reasonInput.style.display = needsReason ? 'inline-block' : 'none';
        if (!needsReason) {
            reasonInput.value = '';
        }
    });

    // Bulk delete
    document.getElementById('bulk-delete').addEventListener('click', function() {
        var ids = getSelectedIds();
        if (ids.length === 0) return;
        
        if (!confirm('Delete ' + ids.length + ' task(s)? This cannot be undone.')) return;
        
        var formData = new FormData();
        formData.append('type', 'task');
        formData.append('project_id', '{{ project }}');
        formData.append('epic_id', '{{ epic }}');
        formData.append('ids', ids.join(','));
        formData.append('actions', JSON.stringify([{type: 'delete'}]));
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
        
        fetch('{% url "bulk_update_items" %}', { method: 'POST', body: formData })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.success) {
                    location.reload();
                }
            });
    });
    
    // Cancel selection
    document.getElementById('bulk-cancel').addEventListener('click', function() {
        document.querySelectorAll('.task-checkbox').forEach(function(cb) {
            cb.checked = false;
        });
        selectAll.checked = false;
        updateBulkBar();
    });

    // Auto-submit due date form on change
    var dueDateInput = document.getElementById('quick_due_date');
    if (dueDateInput) {
        dueDateInput.addEventListener('change', function() {
            this.form.submit();
        });
    }

    // Searchable tag dropdowns (labels and people)
    document.querySelectorAll('.tag-search').forEach(function(input) {
        var targetId = input.getAttribute('data-target');
        var dropdown = document.getElementById(targetId);
        var createOption = dropdown ? dropdown.querySelector('.tag-create') : null;
        
        if (!dropdown) return;
        
        input.addEventListener('input', function() {
            var query = input.value.toLowerCase().trim();
            var hasExactMatch = false;
            var visibleOptions = 0;
            
            // Show/hide existing options
            dropdown.querySelectorAll('.tag-option:not(.tag-create)').forEach(function(opt) {
                var searchText = opt.getAttribute('data-search') || '';
                searchText = searchText.toLowerCase();
                if (query && searchText.includes(query)) {
                    opt.classList.remove('hidden');
                    visibleOptions++;
                    if (searchText === query) hasExactMatch = true;
                } else if (query) {
                    opt.classList.add('hidden');
                } else {
                    // Show all when query is empty
                    opt.classList.remove('hidden');
                    visibleOptions++;
                }
            });
            
            // Show/hide create option
            if (createOption) {
                if (query && !hasExactMatch) {
                    createOption.classList.remove('hidden');
                    var nameSpan = createOption.querySelector('.new-tag-name');
                    var valueInput = createOption.querySelector('.new-tag-value');
                    if (nameSpan) nameSpan.textContent = input.value;
                    if (valueInput) valueInput.value = input.value;
                } else if (query && visibleOptions === 0) {
                    // Show create option if no matches found
                    createOption.classList.remove('hidden');
                    var nameSpan = createOption.querySelector('.new-tag-name');
                    var valueInput = createOption.querySelector('.new-tag-value');
                    if (nameSpan) nameSpan.textContent = input.value;
                    if (valueInput) valueInput.value = input.value;
                } else {
                    createOption.classList.add('hidden');
                }
            }
        });
        
        input.addEventListener('focus', function() {
            dropdown.style.display = 'block';
            // Show create option if there's text and no exact match
            if (createOption && input.value.trim()) {
                var query = input.value.toLowerCase().trim();
                var hasExactMatch = false;
                dropdown.querySelectorAll('.tag-option:not(.tag-create)').forEach(function(opt) {
                    var searchText = (opt.getAttribute('data-search') || '').toLowerCase();
                    if (searchText === query) hasExactMatch = true;
                });
                if (!hasExactMatch) {
                    createOption.classList.remove('hidden');
                    var nameSpan = createOption.querySelector('.new-tag-name');
                    var valueInput = createOption.querySelector('.new-tag-value');
                    if (nameSpan) nameSpan.textContent = input.value;
                    if (valueInput) valueInput.value = input.value;
                }
            }
        });
        
        input.addEventListener('blur', function() {
            setTimeout(function() {
                dropdown.style.display = 'none';
            }, 200);
        });
    });

    // Searchable note dropdown
    document.querySelectorAll('.note-search').forEach(function(input) {
        var targetId = input.getAttribute('data-target');
        var dropdown = document.getElementById(targetId);
        
        input.addEventListener('input', function() {
            var query = input.value.toLowerCase();
            dropdown.querySelectorAll('.note-option').forEach(function(opt) {
                var searchText = opt.getAttribute('data-search').toLowerCase();
                if (searchText.includes(query)) {
                    opt.classList.remove('hidden');
                } else {
                    opt.classList.add('hidden');
                }
            });
        });
        
        input.addEventListener('focus', function() {
            dropdown.style.display = 'block';
        });
        
        input.addEventListener('blur', function() {
            setTimeout(function() {
                dropdown.style.display = 'none';
            }, 200);
        });
    });

    // Table sorting
    var sortDirection = {};
    document.querySelectorAll('.sortable-table .sortable').forEach(function(header) {
        header.style.cursor = 'pointer';
        header.addEventListener('click', function() {
            var column = this.getAttribute('data-sort');
            var table = this.closest('table');
            var tbody = table.querySelector('tbody');
            var rows = Array.from(tbody.querySelectorAll('tr'));
            
            // Toggle sort direction
            if (!sortDirection[column]) {
                sortDirection[column] = 'asc';
            } else {
                sortDirection[column] = sortDirection[column] === 'asc' ? 'desc' : 'asc';
            }
            
            // Sort rows
            rows.sort(function(a, b) {
                var aVal = a.getAttribute('data-' + column) || '';
                var bVal = b.getAttribute('data-' + column) || '';
                
                // Handle numeric values (priority)
                if (column === 'priority') {
                    aVal = parseInt(aVal) || 999;
                    bVal = parseInt(bVal) || 999;
                }
                
                // Handle date values
                if (column === 'created' || column === 'due_date') {
                    // Dates are already in YYYY-MM-DD format, so string comparison works
                }
                
                // Handle text values (title)
                if (column === 'title') {
                    aVal = aVal.toLowerCase();
                    bVal = bVal.toLowerCase();
                }
                
                if (aVal < bVal) return sortDirection[column] === 'asc' ? -1 : 1;
                if (aVal > bVal) return sortDirection[column] === 'asc' ? 1 : -1;
                return 0;
            });
            
            // Re-append sorted rows
            rows.forEach(function(row) {
                tbody.appendChild(row);
            });
            
            // Update sort indicators
            table.querySelectorAll('.sort-indicator').forEach(function(ind) {
                ind.textContent = '↕';
            });
            var indicator = this.querySelector('.sort-indicator');
            indicator.textContent = sortDirection[column] === 'asc' ? '↑' : '↓';
        });
    });
</script>

<!-- Move Epic Modal -->
<div class="help-modal" id="move-epic-modal">
    <div class="help-modal-content">
        <div class="help-modal-header">
            <h3>Move Epic</h3>
            <button class="help-modal-close" id="move-epic-close">&times;</button>
        </div>
        <div class="help-content">
            <form id="move-epic-form">
                <div class="form-group">
                    <label for="move-target-project">Project</label>
                    <select name="target_project" id="move-target-project" required>
                        <option value="">Select Project...</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="submit">Move Epic</button>
                    <button type="button" id="move-epic-cancel">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Move Epic Modal
var moveEpicButton = document.getElementById('move-epic-button');
var moveEpicModal = document.getElementById('move-epic-modal');
var moveEpicClose = document.getElementById('move-epic-close');
var moveEpicCancel = document.getElementById('move-epic-cancel');
var moveEpicForm = document.getElementById('move-epic-form');
var moveTargetProject = document.getElementById('move-target-project');
var projectsLoaded = false;

if (moveEpicButton && moveEpicModal) {
    moveEpicButton.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        moveEpicModal.classList.add('show');
        
        // Load projects if not already loaded
        if (!projectsLoaded) {
            fetch('{% url "move_epic" project=project epic=epic %}', {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(function(response) { return response.json(); })
            .then(function(data) {
                if (data.projects) {
                    moveTargetProject.innerHTML = '<option value="">Select Project...</option>';
                    data.projects.forEach(function(project) {
                        var option = document.createElement('option');
                        option.value = project.id;
                        option.textContent = project.title;
                        moveTargetProject.appendChild(option);
                    });
                    projectsLoaded = true;
                }
            })
            .catch(function(err) {
                alert('Error loading projects: ' + err.message);
            });
        }
    });
    
    if (moveEpicClose) {
        moveEpicClose.addEventListener('click', function(e) {
            e.stopPropagation();
            moveEpicModal.classList.remove('show');
        });
    }
    
    if (moveEpicCancel) {
        moveEpicCancel.addEventListener('click', function(e) {
            e.preventDefault();
            moveEpicModal.classList.remove('show');
        });
    }
    
    // Handle form submission
    if (moveEpicForm) {
        moveEpicForm.addEventListener('submit', function(e) {
            e.preventDefault();
            var formData = new FormData(moveEpicForm);
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
            
            fetch('{% url "move_epic" project=project epic=epic %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(function(response) { return response.json(); })
            .then(function(data) {
                if (data.success) {
                    // Redirect to new epic location
                    window.location.href = data.url;
                } else {
                    alert('Error: ' + (data.error || 'Failed to move epic'));
                }
            })
            .catch(function(err) {
                alert('Error: ' + err.message);
            });
        });
    }
    
    // Close modal when clicking outside (on backdrop only)
    moveEpicModal.addEventListener('click', function(e) {
        // Only close if clicking directly on the backdrop, not on the content
        if (e.target === moveEpicModal) {
            moveEpicModal.classList.remove('show');
        }
    });
    
    // Prevent clicks inside modal content from closing the modal
    var moveEpicContent = moveEpicModal.querySelector('.help-modal-content');
    if (moveEpicContent) {
        moveEpicContent.addEventListener('click', function(e) {
            // Don't stop propagation on select elements - let them work normally
            if (e.target.tagName !== 'SELECT' && !e.target.closest('select')) {
                e.stopPropagation();
            }
        });
    }
}

    // Description editing
    var descriptionEditBtn = document.getElementById('description-edit-btn');
    var descriptionAddBtn = document.getElementById('description-add-btn');
    var descriptionAddRow = document.getElementById('description-add-row');
    var descriptionContainer = document.getElementById('description-container');
    var descriptionDisplay = document.getElementById('description-display');
    var descriptionEditorContainer = document.getElementById('description-editor-container');
    var descriptionEditor = document.getElementById('description-editor');
    var descriptionSaveBtn = document.getElementById('description-save-btn');
    var descriptionCancelBtn = document.getElementById('description-cancel-btn');
    var descriptionMDE = null;
    var originalContent = descriptionEditor ? descriptionEditor.value : '';

    // Handle "Add description" button click
    if (descriptionAddBtn) {
        descriptionAddBtn.addEventListener('click', function() {
            // Hide "Add description" row
            if (descriptionAddRow) {
                descriptionAddRow.style.display = 'none';
            }
            
            // Show description container
            if (descriptionContainer) {
                descriptionContainer.style.display = 'block';
            }
            
            // Show editor container
            descriptionEditorContainer.style.display = 'block';
            
            // Initialize EasyMDE if not already initialized
            if (!descriptionMDE && descriptionEditor) {
                descriptionMDE = new EasyMDE({
                    element: descriptionEditor,
                    spellChecker: false,
                    toolbar: ['bold', 'italic', 'heading', '|', 'quote', 'unordered-list', 'ordered-list', '|', 'link', 'image', 'code', 'table', '|', 'preview', 'side-by-side', 'fullscreen', '|', 'guide'],
                    minHeight: '200px',
                    placeholder: 'Enter description... (Markdown supported)',
                    status: false,
                    autosave: {
                        enabled: false
                    }
                });
                originalContent = '';
                
                // Initialize @mention autocomplete for description editor
                initMentionAutocomplete(descriptionMDE);
                
                // Handle clipboard image paste (Ctrl+V)
                descriptionMDE.codemirror.on('paste', function(cm, e) {
                    var clipboardData = e.clipboardData || window.clipboardData;
                    if (!clipboardData) return;
                    
                    var items = clipboardData.items;
                    if (!items) return;
                    
                    // Check if clipboard contains image
                    for (var i = 0; i < items.length; i++) {
                        if (items[i].type.indexOf('image') !== -1) {
                            e.preventDefault();
                            var file = items[i].getAsFile();
                            
                            // Show loading indicator
                            var cursor = cm.getCursor();
                            var loadingText = '![Uploading image...]()';
                            cm.replaceRange(loadingText, cursor);
                            
                            // Upload image
                            var formData = new FormData();
                            formData.append('image', file);
                            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
                            
                            fetch('{% url "upload_image" %}', {
                                method: 'POST',
                                body: formData,
                                headers: {
                                    'X-Requested-With': 'XMLHttpRequest'
                                }
                            })
                            .then(function(response) {
                                return response.json();
                            })
                            .then(function(data) {
                                if (data.success) {
                                    // Replace loading text with markdown image
                                    var markdownImage = '![' + file.name + '](' + data.url + ')';
                                    var content = cm.getValue();
                                    content = content.replace(loadingText, markdownImage);
                                    cm.setValue(content);
                                } else {
                                    // Replace loading text with error message
                                    var errorText = '![Image upload failed: ' + (data.error || 'Unknown error') + ']()';
                                    var content = cm.getValue();
                                    content = content.replace(loadingText, errorText);
                                    cm.setValue(content);
                                }
                            })
                            .catch(function(err) {
                                // Replace loading text with error message
                                var errorText = '![Image upload failed: Network error]()';
                                var content = cm.getValue();
                                content = content.replace(loadingText, errorText);
                                cm.setValue(content);
                            });
                            
                            return;
                        }
                    }
                });
            }
        });
    }

    if (descriptionEditBtn && descriptionEditor) {
        descriptionEditBtn.addEventListener('click', function() {
            // Hide display and edit button
            descriptionDisplay.style.display = 'none';
            descriptionEditBtn.style.display = 'none';
            
            // Show editor container
            descriptionEditorContainer.style.display = 'block';
            
            // Initialize EasyMDE if not already initialized
            if (!descriptionMDE) {
                descriptionMDE = new EasyMDE({
                    element: descriptionEditor,
                    spellChecker: false,
                    toolbar: ['bold', 'italic', 'heading', '|', 'quote', 'unordered-list', 'ordered-list', '|', 'link', 'image', 'code', 'table', '|', 'preview', 'side-by-side', 'fullscreen', '|', 'guide'],
                    minHeight: '200px',
                    placeholder: 'Enter description... (Markdown supported)',
                    status: false,
                    autosave: {
                        enabled: false
                    }
                });
                originalContent = descriptionMDE.value();
                
                // Initialize @mention autocomplete for description editor
                initMentionAutocomplete(descriptionMDE);
                
                // Handle clipboard image paste (Ctrl+V)
                descriptionMDE.codemirror.on('paste', function(cm, e) {
                    var clipboardData = e.clipboardData || window.clipboardData;
                    if (!clipboardData) return;
                    
                    var items = clipboardData.items;
                    if (!items) return;
                    
                    // Check if clipboard contains image
                    for (var i = 0; i < items.length; i++) {
                        if (items[i].type.indexOf('image') !== -1) {
                            e.preventDefault();
                            var file = items[i].getAsFile();
                            
                            // Show loading indicator
                            var cursor = cm.getCursor();
                            var loadingText = '![Uploading image...]()';
                            cm.replaceRange(loadingText, cursor);
                            
                            // Upload image
                            var formData = new FormData();
                            formData.append('image', file);
                            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
                            
                            fetch('{% url "upload_image" %}', {
                                method: 'POST',
                                body: formData,
                                headers: {
                                    'X-Requested-With': 'XMLHttpRequest'
                                }
                            })
                            .then(function(response) {
                                return response.json();
                            })
                            .then(function(data) {
                                if (data.success) {
                                    // Replace loading text with markdown image
                                    var markdownImage = '![' + file.name + '](' + data.url + ')';
                                    var content = cm.getValue();
                                    content = content.replace(loadingText, markdownImage);
                                    cm.setValue(content);
                                } else {
                                    // Replace loading text with error message
                                    var errorText = '![Image upload failed: ' + (data.error || 'Unknown error') + ']()';
                                    var content = cm.getValue();
                                    content = content.replace(loadingText, errorText);
                                    cm.setValue(content);
                                }
                            })
                            .catch(function(err) {
                                // Replace loading text with error message
                                var errorText = '![Image upload failed: Network error]()';
                                var content = cm.getValue();
                                content = content.replace(loadingText, errorText);
                                cm.setValue(content);
                            });
                            
                            return;
                        }
                    }
                });
            } else {
                descriptionMDE.value(originalContent);
            }
        });

        if (descriptionSaveBtn) {
            descriptionSaveBtn.addEventListener('click', function() {
                var content = descriptionMDE ? descriptionMDE.value() : descriptionEditor.value;
                var formData = new FormData();
                formData.append('quick_update', 'description');
                formData.append('description', content);
                formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

                fetch('{% url "epic_detail" project=project epic=epic %}', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(function(response) { return response.json(); })
                .then(function(data) {
                    if (data.success) {
                        // Update display with rendered markdown
                        descriptionDisplay.innerHTML = data.content || '<span style="color: #828282;">No description</span>';
                        originalContent = content;
                        
                        // Switch back to view mode
                        descriptionEditorContainer.style.display = 'none';
                        descriptionDisplay.style.display = 'block';
                        descriptionEditBtn.style.display = 'block';
                    } else {
                        alert('Error saving description');
                    }
                })
                .catch(function(err) {
                    console.error('Error saving description:', err);
                    alert('Error saving description');
                });
            });
        }

        if (descriptionCancelBtn) {
            descriptionCancelBtn.addEventListener('click', function() {
                // Restore original content
                if (descriptionMDE) {
                    descriptionMDE.value(originalContent);
                } else {
                    descriptionEditor.value = originalContent;
                }
                
                // Switch back to view mode
                descriptionEditorContainer.style.display = 'none';
                descriptionDisplay.style.display = 'block';
                descriptionEditBtn.style.display = 'block';
            });
        }
    }
</script>
{% endblock %}
