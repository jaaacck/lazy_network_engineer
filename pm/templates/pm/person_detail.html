{% extends "pm/base.html" %}
{% load markdown_extras %}

{% block content %}
<div class="breadcrumb">
    <a href="{% url 'project_list' %}">projects</a> &gt;
    <a href="{% url 'people_list' %}">people</a> &gt;
    @{{ person_name }}
</div>

<div class="page-title">@{{ person_name }}</div>

<div class="section">
    <div class="section-title">
        Person Information
    </div>
    <div class="overview-section">
        <div class="overview-row">
            <div class="overview-field">
                <strong>Name:</strong> {{ metadata.name|default:person_name }}
            </div>
        </div>
        {% if metadata.job_title %}
        <div class="overview-row">
            <div class="overview-field">
                <strong>Job Title:</strong> {{ metadata.job_title }}
            </div>
        </div>
        {% endif %}
        {% if metadata.company %}
        <div class="overview-row">
            <div class="overview-field">
                <strong>Company:</strong> {{ metadata.company }}
            </div>
        </div>
        {% endif %}
        {% if metadata.email %}
        <div class="overview-row">
            <div class="overview-field">
                <strong>Email:</strong> <a href="mailto:{{ metadata.email }}">{{ metadata.email }}</a>
            </div>
        </div>
        {% endif %}
        {% if metadata.phone %}
        <div class="overview-row">
            <div class="overview-field">
                <strong>Phone:</strong> <a href="tel:{{ metadata.phone }}">{{ metadata.phone }}</a>
            </div>
        </div>
        {% endif %}
        <div class="overview-row">
            <div class="overview-field">
                <strong>First Created:</strong> 
                {% if metadata.created %}
                    {% if "T" in metadata.created %}
                        {{ metadata.created|slice:":10" }} {{ metadata.created|slice:"11:19" }}
                    {% else %}
                        {{ metadata.created }}
                    {% endif %}
                {% else %}
                    Not set
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="section">
    <div class="section-title">All References ({{ total_refs }})</div>
    
    {% if projects %}
    <details class="section" open>
        <summary>Projects ({{ projects|length }})</summary>
        <div class="item-list">
            {% for project in projects %}
            <div class="item">
                <div class="item-title">
                    <a href="{{ project.url }}">{{ project.title }}</a>
                </div>
            </div>
            {% endfor %}
        </div>
    </details>
    {% endif %}
    
    {% if epics %}
    <details class="section" {% if epics %}open{% endif %}>
        <summary>Epics ({{ epics|length }})</summary>
        <div class="item-list">
            {% for epic in epics %}
            <div class="item">
                <div class="item-title">
                    {% if epic.seq_id %}<span class="seq-id">{{ epic.seq_id }}</span>{% endif %}
                    <a href="{{ epic.url }}">{{ epic.title }}</a>
                </div>
                <div class="item-meta">{{ epic.project_title }}</div>
            </div>
            {% endfor %}
        </div>
    </details>
    {% endif %}
    
    {% if tasks %}
    <details class="section" {% if tasks %}open{% endif %}>
        <summary>Tasks ({{ tasks|length }})</summary>
        <div class="item-list">
            {% for task in tasks %}
            <div class="item">
                <div class="item-title">
                    {% if task.seq_id %}<span class="seq-id">{{ task.seq_id }}</span>{% endif %}
                    <a href="{{ task.url }}">{{ task.title }}</a>
                </div>
                <div class="item-meta">{{ task.epic_title }} &gt; {{ task.project_title }}</div>
            </div>
            {% endfor %}
        </div>
    </details>
    {% endif %}
    
    {% if subtasks %}
    <details class="section" {% if subtasks %}open{% endif %}>
        <summary>Subtasks ({{ subtasks|length }})</summary>
        <div class="item-list">
            {% for subtask in subtasks %}
            <div class="item">
                <div class="item-title">
                    {% if subtask.seq_id %}<span class="seq-id">{{ subtask.seq_id }}</span>{% endif %}
                    <a href="{{ subtask.url }}">{{ subtask.title }}</a>
                </div>
                <div class="item-meta">{{ subtask.task_title }} &gt; {{ subtask.epic_title }} &gt; {{ subtask.project_title }}</div>
            </div>
            {% endfor %}
        </div>
    </details>
    {% endif %}
    
    {% if notes %}
    <details class="section" {% if notes %}open{% endif %}>
        <summary>Notes ({{ notes|length }})</summary>
        <div class="item-list">
            {% for note in notes %}
            <div class="item">
                <div class="item-title">
                    <a href="{{ note.url }}">{{ note.title }}</a>
                </div>
                <div class="item-meta">
                    Created: {{ note.created }}{% if note.updated != note.created %} | Updated: {{ note.updated }}{% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </details>
    {% endif %}
    
    {% if total_refs == 0 %}
    <div class="empty">No references found for @{{ person_name }}.</div>
    {% endif %}
</div>
{% endblock %}
